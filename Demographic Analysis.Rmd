---
title: "Trajectories"
author: "Zachary"
date: '2025-07-28'
output: html_document
---

  
# Library & Notes
```{r setup, include=FALSE}
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ## ðŸ“¦ Data Import & Manipulation
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  library(haven)       # Read SPSS, SAS, Stata files
  library(readr)       # Read CSVs
  library(readxl)      # Read Excel files
  library(data.table)  # Fast data manipulation
  library(dplyr)       # Data manipulation
  library(tidyr)       # Data tidying
  library(stringr)     # String operations
  library(purrr)       # Functional programming
  library(zoo)         # Time series & rolling functions
  library(lubridate)   # Dates & times
  library(fuzzyjoin)   # Fuzzy matching joins
  
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ## ðŸ“Š Modeling & Statistics
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  library(lme4)        # Mixed-effects models
  library(lmerTest)    # p-values for lmer
  library(coxme)       # Cox mixed-effects models
  library(survival)    # Survival analysis
  library(MuMIn)       # Model selection & RÂ²
  library(lsmeans)     # Least-squares means (now emmeans)
  library(mgcv)        # Generalized Additive Models
  library(gratia)      # GAM diagnostics & visualization
  library(gamm4)       # GAMM fitting
  
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ## ðŸ“‘ Tables & Reporting
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  library(broom)       # Tidy model output
  library(pander)      # Pretty markdown tables
  library(apaTables)   # APA-style tables
  library(flextable)   # Formatted tables
  library(officer)     # Export to Word/PowerPoint
  library(webshot2)    # Save HTML tables/images
  
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ## ðŸŽ¨ Plotting & Visualization
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  library(ggplot2)     # General plotting
```

#Load Data
```{r}
setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
# setwd("C:/Users/zachh/Documents/Code/git/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git") # Home Computer

FOR <- readr::read_csv("FOR2.csv", col_types = cols(.default = col_character())) 
Night <- readr::read_csv("part4_nightsummary_sleep_cleaned.csv", col_types = cols(.default = col_character())) 
NightM <- read_excel("motionloggerdata.xlsx")
```

#Merge Datasets
```{r}
FOR <- FOR %>%
  group_by(subject_id) %>%
  mutate(
    race = ifelse(
      is.na(race),
      race[is.na(time_point)][1],  # take ethnicity where timepoint is NA
      race
    )
  ) %>%
  ungroup()

Night$Subject_ID <- substr(Night$filename, 1, 12)
Night$Assessment_Date <- str_extract(Night$filename, "\\d{4}-\\d{2}-\\d{2}")
Night <- Night %>% filter(!str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))

bin_files_to_remove <- c("8000103174_left wrist_068158_2025-06-03 10-40-36.bin", "8000156273_left wrist_060381_2024-11-05 12-04-08_partial.bin", "8000156273_left wrist_060381_2024-11-05 12-27-40.bin", "800304581_right wrist_060843_2024-11-05 13-16-09.bin", "800304582__060365_2024-11-05 12-03-44.bin",  "800304582__060365_2024-11-05 12-28-01.bin")

Night <- Night %>% filter(!filename %in% bin_files_to_remove)
Night <- Night %>% mutate(Subject_ID = gsub("^800-(\\d{3})-(\\d+)_$", "800-0\\1-\\2", Subject_ID))

Night$Subject_ID <- gsub("-", "", Night$Subject_ID)
Night$Subject_ID <- gsub("[a-zA-Z]", "", Night$Subject_ID)
Night$Subject_ID <- gsub("_", "", Night$Subject_ID)
FOR$Subject_ID <- gsub("-", "", as.character(FOR$subject_id))
Night$SleepDurationInSpt <- as.numeric(Night$SleepDurationInSpt)
Night <- Night %>%
  group_by(filename) %>%
  summarise(
    Subject_ID = first(Subject_ID),
    Assessment_Date = first(Assessment_Date),
    TSTm = mean(SleepDurationInSpt, na.rm = TRUE))
unique(Night$Subject_ID)

setDT(Night)
setDT(FOR)
Night$geneactiv <- 1
FOR[, Assessment_Date := as.Date(assessment_date)]
FOR$Assessment_Date_FOR <- FOR$Assessment_Date
Night[, Assessment_Date := as.Date(Assessment_Date)]  
Night$Assessment_Date_Night <- Night$Assessment_Date

# Perform the join with date window logic
merged1 <- Night[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged1[, diffdays := abs(as.numeric(difftime(Assessment_Date_Night, Assessment_Date_FOR, units = "days")))]
mergedfilt <- merged1 %>% filter(!diffdays <= 179)
merged1 <- merged1 %>% filter(diffdays <= 179)

NightM <- NightM %>%
  mutate(filename = paste0(ID, "motionlogg"))
NightM$weekday <- NightM$eday
NightM <- NightM %>% 
  filter(!str_detect(Subject_ID, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))

setDT(NightM)
NightM[, Assessment_Date := as.Date(sdate)]
NightM <- NightM %>%
  group_by(filename) %>%
  summarise(
    Subject_ID = first(Subject_ID),
    Assessment_Date = first(Assessment_Date),
    TSTm = mean(SleepDurationInSpt, na.rm = TRUE))
unique(NightM$Subject_ID)
NightM$Assessment_date_nightM <- NightM$Assessment_Date

setDT(FOR)
setDT(NightM)
merged2 <- NightM[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged2[, diffdays := abs(as.numeric(difftime(Assessment_date_nightM, Assessment_Date_FOR, units = "days")))]
merged2 <- merged2 %>% filter(diffdays <= 179)
merged2$motionlogger <- 1
unique(merged2$Subject_ID)

merged <- rbindlist(list(merged1, merged2), fill = TRUE)

merged %>%
  filter(geneactiv == 1) %>%
  ggplot(aes(x = floor(as.numeric(age)))) +
  geom_bar() +
  scale_x_continuous(
    limits = c(0, 25),
    breaks = seq(0, 25, by = 3)
  ) +
  labs(
    title = "Distribution of Assessment Dates (by Year)",
    x = "Age (years)",
    y = "Number of Assessments"
  ) +
  theme_minimal()

merged %>%
  filter(motionlogger == 1) %>%
  ggplot(aes(x = floor(as.numeric(age)))) +
  geom_bar() +
  scale_x_continuous(
    limits = c(0, 25),
    breaks = seq(0, 25, by = 3)
  ) +
  labs(
    title = "Distribution of Assessment Dates (by Year)",
    x = "Age (years)",
    y = "Number of Assessments"
  ) +
  theme_minimal()

```

#Non Participators 
```{r}
list <- unique(merged$Subject_ID)
unmerged <- FOR[!Subject_ID %in% list]
unique(unmerged$Subject_ID)
unmerged <- unmerged %>%
  group_by(Subject_ID) %>%
  arrange(Assessment_Date, .by_group = TRUE) %>%
  slice_tail(n = 2) %>%        # keep the last 2
  slice_head(n = 1) %>%        # keep the earlier of those 2 â†’ 2nd most recent
  ungroup()

table(unmerged$assessment_date)




unmerged <- unmerged %>%
  mutate(fhr = ifelse(group %in% c(1, 2, 3), 1, 0))
unmerged$sex <- factor(unmerged$sex,
                       levels = c(0, 1),
                       labels = c("Male", "Female"))
unmerged <- unmerged %>%
  filter(group != 3)
table(unmerged$group)

##YEAR
cutoff <- as.Date("2021-07-01")
n_before <- nrow(unmerged)
unmerged <- unmerged %>%
  filter(Assessment_Date >= cutoff)
n_after <- nrow(unmerged)

# Print how many were filtered out
cat("Filtered out", n_before - n_after, "rows (before July 2021)\n")

##AGE
n_before <- nrow(unmerged)
table(round(as.numeric(unmerged$age)))

unmerged$age <- as.numeric(unmerged$age)
unmerged <- unmerged %>%
  filter(age >= 8)
n_after <- nrow(unmerged)
cat("Filtered out", n_before - n_after, "rows (Age")

##CONSENT
n_before <- nrow(unmerged)
table(unmerged$oconsint, useNA = "always")
unmerged <- unmerged %>%
  filter(oconsint == 2)
n_after <- nrow(unmerged)
cat("Filtered out", n_before - n_after, "rows (Age")

class(merged$age)


unique(merged$subject_id)
unique(unmerged$subject_id)

#Age
t.test(merged$age, unmerged$age)

#Fhr
chisq.test(table(merged$fhr, unmerged$fhr))
merged$participation <- "Participated"
unmerged$participation <- "Did_Not_Participate"
combined <- bind_rows(
  merged %>% select(fhr, participation),
  unmerged %>% select(fhr, participation)
)
combined$fhr <- factor(combined$fhr, levels = c(0, 1), labels = c("Control", "FHR"))
table(combined$participation, combined$fhr)
chisq.test(table(combined$participation, combined$fhr))

#Sex
merged$participation <- "Participated"
unmerged$participation <- "Did_Not_Participate"
combined <- bind_rows(
  merged %>% select(sex, participation),
  unmerged %>% select(sex, participation)
)
combined$fhr <- factor(combined$sex, levels = c(0, 1), labels = c("Male", "Female"))
table(combined$participation, combined$sex)
chisq.test(table(combined$participation, combined$sex))

```




#Demographics
```{r}
merged$age <- as.numeric(merged$age)
merged$time_point <- as.numeric(merged$time_point)


merged <- merged %>%
  mutate(fhr = ifelse(group %in% c(1, 2, 3), 1, 0))
merged$group <- factor(merged$group,
                       levels = c(0, 1, 2, 3),
                       labels = c("Control", "MDD Risk", "BD Risk", "Psy Risk"))
merged$sex <- factor(merged$sex,
                       levels = c(0, 1),
                       labels = c("Male", "Female"))
merged <- merged %>%
  mutate(
    mdd = factor(ifelse(group == "MDD Risk", 1, 0), levels = c(0, 1)),
    bd  = factor(ifelse(group == "BD Risk", 1, 0), levels = c(0, 1))
  )

table(merged$race)

merged <- merged %>%
  mutate(race = ifelse(is.na(race) | race %in% c(5, 6), 9, race))

merged$race <- factor(merged$race,
                      levels = c(1, 2, 3, 4, 9),
                      labels = c("White", "Black", "Asian", "First Nation", "Other"))

table(merged$group, merged$race, useNA = "always")


merged <- merged %>% filter(age >= 8)
merged <- merged %>% filter(group != 'Psy Risk')

```

#APA Tables
```{r}
library(apaTables)

library(dplyr)
library(dplyr)
library(tidyr)
library(flextable)

setDT(merged)

# Step 1: Control vs FHR
merged_subj <- merged %>%
  group_by(subject_id) %>%
  summarise(
    age = mean(age, na.rm = TRUE),
    sex = first(sex),           # categorical â€” take first since it doesnâ€™t change
    fhr = first(fhr),
    group = first(group),
    race = first(race),
    .groups = "drop"
  )



demo_fhr <- merged_subj %>%
  group_by(fhr) %>%
  summarise(
    n = n(),
    age_mean = mean(age, na.rm = TRUE),
    age_sd = sd(age, na.rm = TRUE),
    female_n = sum(sex == "Female", na.rm = TRUE),
    female_pct = round(100 * mean(sex == "Female", na.rm = TRUE), 1),
    white_n = sum(race == "White", na.rm = TRUE),
    black_n = sum(race == "Black", na.rm = TRUE),
    asian_n = sum(race == "Asian", na.rm = TRUE),
    first_n = sum(race == "First Nation", na.rm = TRUE),
    other_n = sum(race == "Other", na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(group_label = ifelse(fhr == 0, "Control", "At-Risk Overall")) %>%
  select(group_label, everything(), -fhr)

# Step 2: FHR subgroups

demo_groups <- merged_subj %>%
  filter(fhr == 1) %>%
  group_by(group) %>%
  summarise(
    n = n(),
    age_mean = mean(age, na.rm = TRUE),
    age_sd = sd(age, na.rm = TRUE),
    female_n = sum(sex == "Female", na.rm = TRUE),
    female_pct = round(100 * mean(sex == "Female", na.rm = TRUE), 1),
    white_n = sum(race == "White", na.rm = TRUE),
    black_n = sum(race == "Black", na.rm = TRUE),
    asian_n = sum(race == "Asian", na.rm = TRUE),
    first_n = sum(race == "First Nation", na.rm = TRUE),
    other_n = sum(race == "Other", na.rm = TRUE),
    .groups = "drop"
  ) %>%
  rename(group_label = group)


# Step 3: Combine
demo_all <- bind_rows(demo_fhr, demo_groups)

demo_all <- demo_all %>% 
  filter(group_label != "At-Risk Overall")


# Step 4: Combine mean Â± SD with paste
demo_all <- demo_all %>%
  mutate(
    `Age (M Â± SD)` = sprintf("%.2f (%.2f)", age_mean, age_sd),
    `Female N (%)` = sprintf("%d (%.1f%%)", female_n, female_pct),
    `White N` = sprintf("%d", white_n),
    `Black N` = sprintf("%d", black_n),
    `Asian N` = sprintf("%d", asian_n),
    `First Nation N` = sprintf("%d", first_n),
    `Other N` = sprintf("%d", other_n)
  ) %>%
  select(group_label, n, `Age (M Â± SD)`, `Female N (%)`, `White N`, `Black N`, `Asian N`, `First Nation N`, `Other N`)

demo_all

# Step 5: Pivot so groups are columns and variables are rows
demo_long <- demo_all %>%
  mutate(across(-group_label, as.character)) %>%  # make all non-label columns characters
  pivot_longer(
    cols = -group_label,
    names_to = "Variable",
    values_to = "Value"
  ) %>%
  pivot_wider(
    names_from = group_label,
    values_from = Value
  )


demo_long

ft <- flextable(demo_long)
ft <- set_header_labels(ft, Variable = "") |>
  theme_booktabs() |>
  autofit() |>
  align(align = "center", part = "all") |>
  bold(part = "header") |>
  fontsize(size = 11, part = "all")

ft
# Export
setwd("outputs")
save_as_docx(ft, path = "Table1_Demographics_APA.docx")

merged_subj <- merged_subj %>%
  filter(group != "Psy Risk") %>%      # remove rows
  mutate(group = droplevels(group))    # drop the factor level


tbl_sex <- table(merged_subj$group, merged_subj$sex)
tbl_sex

chisq_sex <- chisq.test(tbl_sex)
chisq_sex

tbl_race <- table(merged_subj$group, merged_subj$race)
tbl_race

chisq_race <- chisq.test(tbl_race)
chisq_race



merged_subj$White        <- merged_subj$race == "White"
merged_subj$Black        <- merged_subj$race == "Black"
merged_subj$Asian        <- merged_subj$race == "Asian"
merged_subj$FirstNation  <- merged_subj$race == "First Nation"
merged_subj$Other        <- merged_subj$race == "Other"


chisq_white <- chisq.test(table(merged_subj$group, merged_subj$White))
chisq_white


chisq_black <- chisq.test(table(merged_subj$group, merged_subj$Black))
chisq_black


chisq_asian <- chisq.test(table(merged_subj$group, merged_subj$Asian))
chisq_asian


chisq_fn <- chisq.test(table(merged_subj$group, merged_subj$FirstNation))
chisq_fn


chisq_other <- chisq.test(table(merged_subj$group, merged_subj$Other))
chisq_other

anova_age <- aov(age ~ group, data = merged_subj)
summary(anova_age)

```



