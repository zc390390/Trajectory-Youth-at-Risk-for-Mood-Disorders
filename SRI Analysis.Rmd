---
title: "Trajectories"
author: "Zachary"
date: '2025-07-28'
output: html_document
---

# Library & Notes
```{r setup, include=FALSE}
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸ“¦ Data Import & Manipulation
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(haven)       # Read SPSS, SAS, Stata files
library(readr)       # Read CSVs
library(readxl)      # Read Excel files
library(data.table)  # Fast data manipulation
library(dplyr)       # Data manipulation
library(tidyr)       # Data tidying
library(stringr)     # String operations
library(purrr)       # Functional programming
library(zoo)         # Time series & rolling functions
library(lubridate)   # Dates & times
library(fuzzyjoin)   # Fuzzy matching joins

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸ“Š Modeling & Statistics
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(lme4)        # Mixed-effects models
library(lmerTest)    # p-values for lmer
library(coxme)       # Cox mixed-effects models
library(survival)    # Survival analysis
library(MuMIn)       # Model selection & RÂ²
library(lsmeans)     # Least-squares means (now emmeans)
library(mgcv)        # Generalized Additive Models
library(gratia)      # GAM diagnostics & visualization
library(gamm4)       # GAMM fitting

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸ“‘ Tables & Reporting
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(broom)       # Tidy model output
library(pander)      # Pretty markdown tables
library(apaTables)   # APA-style tables
library(flextable)   # Formatted tables
library(officer)     # Export to Word/PowerPoint
library(webshot2)    # Save HTML tables/images

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸŽ¨ Plotting & Visualization
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(ggplot2)     # General plotting
```

#Non-Mean Exploration
```{r}
# setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
# setwd("C:/Users/zachh/Documents/Code/git/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data") # Tupper Windows Comp
setwd("C:/Users/zacha/Documents/forbow/code/git/data") # Home Computer

FOR <- readr::read_csv("FOR2.csv", col_types = cols(.default = col_character()))
Night <- readr::read_csv("part4_nightsummary_sleep_cleaned.csv", col_types = cols(.default = col_character()))
NightM <- read_excel("motionloggerdata.xlsx")

Night$Subject_ID <- substr(Night$filename, 1, 12)
Night$Assessment_Date <- str_extract(Night$filename, "\\d{4}-\\d{2}-\\d{2}")
Night <- Night %>% 
  filter(!str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))

##Why are we removing this         
bin_files_to_remove <- c(
  "8000103174_left wrist_068158_2025-06-03 10-40-36.bin",
  "8000156273_left wrist_060381_2024-11-05 12-04-08_partial.bin",
  "8000156273_left wrist_060381_2024-11-05 12-27-40.bin",
  "800304581_right wrist_060843_2024-11-05 13-16-09.bin",
  "800304582__060365_2024-11-05 12-03-44.bin",
  "800304582__060365_2024-11-05 12-28-01.bin"
)
Night <- Night %>%
  filter(!filename %in% bin_files_to_remove)
Night <- Night %>%
  mutate(Subject_ID = gsub("^800-(\\d{3})-(\\d+)_$", "800-0\\1-\\2", Subject_ID))
Night$Subject_ID <- gsub("-", "", Night$Subject_ID)
Night$Subject_ID <- gsub("[a-zA-Z]", "", Night$Subject_ID)
Night$Subject_ID <- gsub("_", "", Night$Subject_ID)
FOR$Subject_ID <- gsub("-", "", as.character(FOR$subject_id))
setDT(Night)
setDT(FOR)

##GeneACTIV Merging
Night$geneactiv <- 1
FOR[, Assessment_Date := as.Date(assessment_date)]
FOR$Assessment_Date_FOR <- FOR$Assessment_Date
Night[, Assessment_Date := as.Date(Assessment_Date)]  # redundant if already Date
Night$Assessment_Date_Night <- Night$Assessment_Date
merged1 <- Night[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged1[, diffdays := abs(as.numeric(difftime(Assessment_Date_Night, Assessment_Date_FOR, units = "days")))]
merged1 <- merged1 %>% filter(diffdays <= 179)
two <- merged1[(Subject_ID %in% c(8000038204, 8000114479))]

##Motion Logger Merging
NightM <- NightM %>%
  mutate(filename = paste0(ID, "motionlogg"))
NightM$weekday <- NightM$eday
NightM <- NightM %>% 
  filter(!str_detect(Subject_ID, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))
setDT(NightM)
NightM[, Assessment_Date := as.Date(sdate)]
NightM$Assessment_date_nightM <- NightM$Assessment_Date
merged2 <- NightM[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged2[, diffdays := abs(as.numeric(difftime(Assessment_date_nightM, Assessment_Date_FOR, units = "days")))]
merged2 <- merged2 %>% filter(diffdays <= 179)
merged2$motionlogger <- 1

#Combination of Motion and GeneActiv
merged <- rbindlist(list(merged1, merged2), fill = TRUE)

#Setup
merged$sleeponset <- as.numeric(merged$sleeponset)
merged$wakeup <- as.numeric(merged$wakeup)
base_date <- as.Date("2000-01-01")
merged$sleeponset_time <- as.POSIXct(base_date) + merged$sleeponset * 3600
merged$wakeup_time     <- as.POSIXct(base_date) + merged$wakeup * 3600
```


#SleepRegularity - dev
this is kind of insane rn

Notes:
Seems to be calcultaing well, we need to ensure we are only inputting people who have good data though... and maybe double check its working!
```{r}
merged <- merged %>%
  group_by(subject_id) %>%
  arrange(desc(time_point)) %>%
  mutate(onset_tmrw = lag(sleeponset, 1),
         wake_tmrw = lag(sleeponset, 1)) %>% ungroup()



merged <- merged %>%
  mutate(across(c(sleeponset, wakeup, onset_tmrw, wake_tmrw), as.POSIXct))



tryone <- merged %>% filter(subject_id == '8000300573')



merged$time_onset <- format(merged$sleeponset_time, format = "%H:%M:%S")
merged$sleeponset_minutes <- hour(hms(merged$time_onset)) * 60
                             minute(hms(merged$time_onset)) +
                             second(hms(merged$time_onset)) / 60
merged$sleeponset_minutes <- merged$sleeponset_minutes + 720

merged$time_wake <- format(merged$wakeup_time, format = "%H:%M:%S")
merged$wakeup_minutes <- hour(hms(merged$time_wake)) * 60 +
                         minute(hms(merged$time_wake)) +
                         second(hms(merged$time_wake)) / 60
merged$wakeup_minutes <- merged$wakeup_minutes + 720




subject_ids <- unique(merged$subject_id)

#This needs to filter for individual actigraphy too
merged$SRI2 <- NA_real_
merged$night <- as.numeric(merged$night)

make_binary <- function(onset, wake) {
  epoch <- 720:(720 + 1440 - 1)
  
  if (is.na(onset) || is.na(wake)) {
    return(rep(NA, length(epoch)))
  }
  
  if (onset <= wake) {
    return(ifelse(epoch >= onset & epoch <= wake, 1, 0))
  } else {
    return(ifelse(epoch >= onset | epoch <= wake, 1, 0))
  }
}

merged <- merged %>%
  arrange(subject_id, filename, night) %>%
  group_by(subject_id, filename) %>%
  mutate(
    epoch_binary = purrr::map2(sleeponset_minutes, wakeup_minutes, make_binary),
    
    next_binary  = dplyr::lead(epoch_binary),
    next_night   = dplyr::lead(night),
    
    SRI2 = purrr::map2_dbl(epoch_binary, next_binary, ~{
      if (is.null(.x) || is.null(.y)) return(NA_real_)
      valid_idx <- !is.na(.x) & !is.na(.y)
      if (!any(valid_idx)) return(NA_real_)
      mean(.x[valid_idx] == .y[valid_idx]) * 100
    }) %>%
      ifelse((next_night - night) != 1, NA_real_, .)
  ) %>%
  ungroup() %>%
  select(-epoch_binary, -next_binary, -next_night) 

merged$SRI2_scaled <- (merged$SRI2 * 2) - 100
```

#Data Setup
##Labeling & Filtering
```{r}

#Creating FHR Variable and Weekend
merged <- merged %>%
  mutate(fhr = ifelse(group %in% c(1, 2, 3), 1, 0))

merged$weekend <- ifelse(merged$weekday %in% 
                         c("Sat", "Saturday", "Sun", "Sunday"), 1, 0)

#Labeling
merged$fhr <- factor(merged$fhr,
                       levels = c(0, 1),
                       labels = c("Control", "FHR"))
merged$group <- factor(merged$group,
                       levels = c(0, 1, 2, 3),
                       labels = c("Control", "MDD Risk", "BD Risk", "Psy Risk"))
merged$sex <- factor(merged$sex,
                       levels = c(0, 1),
                       labels = c("Male", "Female"))
merged$weekend <- factor(merged$weekend,
                         levels = c(0, 1),
                         labels = c("Weekday", "Weekend"))
merged$age <- as.numeric(merged$age)
merged$subject_id <- as.factor(merged$subject_id)
merged$SleepDurationInSpt <- as.numeric(merged$SleepDurationInSpt)

#Remove Psy Risk and Those without gruop
merged <- merged %>% filter(age >= 8 & age <= 22)
merged1 <- merged
merged <- merged %>% filter(group != 'Psy Risk')

table(merged$group)

merged1 <- merged1 %>%
  mutate(
    mdd = factor(ifelse(group == "MDD Risk", 1, 0), levels = c(0, 1)),
    bd  = factor(ifelse(group == "BD Risk", 1, 0), levels = c(0, 1)),
    psy = factor(ifelse(group == "Psy Risk", 1, 0), levels = c(0, 1))
  )
```
#Main Analysis
##Linear
```{r}
merged$fhr2 <- ordered(merged$fhr, levels = c("Control", "FHR"))

nonlinear <- gamm(
  SRI2_scaled ~ fhr + sex + weekend +
    s(age, by = fhr, k = 5),
  random = list(fid = ~1, subject_id = ~1),
  data = merged,
  method = "REML"
)

nonlinear_order <- gamm(
  SRI2_scaled ~ fhr2 + sex + weekend + s(age, k = 5) +
    s(age, by = fhr2, k = 5),        # additional smooth for FHR
  random = list(fid = ~1, subject_id = ~1),
  data = merged,
  method = "REML"
)

summary(nonlinear_order$gam)

##Below p value is from the summary, there is likely a way to automate finding it but I dont care
p <- signif(9.44e-05 * 3, 3)
p <- format(p, scientific = FALSE)
p <- ifelse(p < 0.001, "<0.001", format(signif(p, 3), scientific = FALSE))
p

##FDR
p <- 0.000282
```

###Visualization
```{r}
# Create new data for prediction (age sequence)
age_seq <- seq(min(merged$age, na.rm = TRUE),
               max(merged$age, na.rm = TRUE),
               length.out = 200)

# Create a new data frame with average covariate values
newdat <- expand.grid(
  age = age_seq,
  fhr = factor(levels(merged$fhr), levels = levels(merged$fhr)),
  sex = factor(levels(merged$sex)[1], levels = levels(merged$sex)),         # hold sex constant
  weekend = factor(levels(merged$weekend)[1], levels = levels(merged$weekend))  # hold weekend constant
)

# Assign one subject ID (for random effects if included)
newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))

pred <- predict(nonlinear$gam, newdata = newdat, se.fit = TRUE, exclude = "s(subject_id)")

newdat$fit <- pred$fit
newdat$se <- pred$se.fit
z <- qnorm(0.975)  # 1.96
newdat <- newdat %>%
  mutate(
    lower = fit - z * se,
    upper = fit + z * se
  )

# 6. Plot adjusted smooths for groups with ggplot

ggplot(newdat, aes(x = age, y = fit, color = fhr)) +
  geom_line(size = 1.2) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = fhr), alpha = 0.2, color = NA) +
  scale_y_continuous(limits = c(4, 10), breaks = seq(4, 10, by = 2)) +
scale_color_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
scale_fill_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +

  labs(title = "Adjusted Sleep Duration Trajectories by Group",
       x = "Age",
       y = "Predicted Sleep Duration (hours)",
       color = "Group",
       fill = "Group") +
  theme_minimal()

sum <- merged %>%
  group_by(filename) %>%
    summarise(
      SRIm = mean(SRI2_scaled, na.rm = TRUE),
      age = mean(age, na.rm = TRUE),
      fhr = first(fhr)
    )


SRIoutput <- ggplot() +
  # Raw data
  geom_point(data = sum,
             aes(x = age, y = SRIm, color = fhr),
             alpha = 0.25, size = 1.2) +
  
  # Model predictions
  geom_line(data = newdat,
            aes(x = age, y = fit, color = fhr),
            size = 1.2) +
  geom_ribbon(data = newdat,
              aes(x = age, ymin = lower, ymax = upper, fill = fhr),
              alpha = 0.25, color = NA) +
  
  # Scales (match both color & fill and give them the same legend title)
  scale_color_manual(
    name = "Group",                # ðŸ‘ˆ ensures both share same legend title
    values = c("Control" = "#6699FF", "FHR" = "#FF6666")
  ) +
  scale_fill_manual(
    name = "Group",                # ðŸ‘ˆ must be identical to color's 'name'
    values = c("Control" = "#6699FF", "FHR" = "#FF6666")
  ) +
  
  scale_y_continuous(limits = c(60, 100), breaks = seq(60, 100, by = 10)) +
  
  labs(
    title = "Observed and Modelled Sleep Regularity by Group",
    x = "Age",
    y = "Sleep Regularity"
  ) +
  theme_minimal()
SRIoutput

diff <- difference_smooths(
  nonlinear, smooth = "s(age)",                          # base label of the smooth
  n = 2000, unconditional = TRUE,
  interval = "simultaneous", level = 0.983,        # or 0.9833 if you insist on Bonferroni across 3 outcomes
  comp = list(fhr = c("FHR", "Control"))
)

SRIdiff <- ggplot(diff, aes(x = age, y = .diff)) +
  geom_hline(yintercept = 0, color = "black", linewidth = 0.8) +
  geom_ribbon(aes(ymin = .lower_ci, ymax = .upper_ci),
              fill = "#B380B3", alpha = 0.4) +
  geom_line(color = "#B380B3", linewidth = 1.3) +
  ggtitle("Difference in Sleep Regularity (FHR - Control)") +
  xlab("Age") +
  ylab("Difference in Predicted Sleep Regularity") +
  theme_minimal() +
  annotate(
    "text",
    x = min(diff$age, na.rm = TRUE),
    y = min(diff$.lower_ci, na.rm = TRUE),
    label = as.character(
      as.expression(
        bquote(bold(italic("p"))[BH] ~ "=" ~ .(formatC(p, format = "e", digits = 2)))
      )
    ),
    parse = TRUE,
    hjust = 0, vjust = -1, size = 4.2
  )
SRIdiff

SRIoutput <- SRIoutput +
  theme(
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )

SRIdiff <- SRIdiff +
  theme(
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )


library(patchwork)
SRIcombo <- SRIoutput + SRIdiff +
  plot_layout(ncol = 2, widths = c(1, 1)) +
  plot_annotation(
    title = "Sleep Regularity Trajectories and Group Differences",
    theme = theme(
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      plot.margin = margin(15, 15, 15, 15)
    )
  )

SRIcombo



ggsave(
  "SRI_SleepTrajectorieshiconfidence2.png",
  plot = SRIoutput,
  width = 6.9, height = 4.6, units = "in", dpi = 300,
  bg = "white"
)
ggsave(
  "SRI_SleepTrajectorieshiconfidence2.png",
  plot = SRIoutput,
  width = 6.9, height = 4.6, units = "in", dpi = 300,
  bg = "white"
)
ggsave(
  "SRI_Patchwork.png",
  plot = SRIcombo,
  width = 8.5, height = 6.5, units = "in", dpi = 600,
  bg = "white"
)
```

##Nonlinear
###Main
```{r}
##Mid Point
merged$fhr2 <- ordered(merged$fhr, levels = c("Control", "FHR"))


nonlinear <- gamm(
  SRI2_scaled ~ fhr + sex + weekend + 
    s(age, by = fhr, k = 5),        # additional smooth for FHR
  random = list(fid = ~1, subject_id = ~1),
  data = merged,
  method = "REML"
)

nonlinear_order <- gamm(
  SRI2_scaled ~ fhr2 + sex + weekend + s(age, k = 5) +
    s(age, by = fhr2, k = 5),        # additional smooth for FHR
  random = list(fid = ~1, subject_id = ~1),
  data = merged,
  method = "REML"
)


summary(nonlinear_order$gam)
summary(nonlinear$gam)

##Below p value is from the summary, there is likely a way to automate finding it but I dont care
p <- signif(9.44e-05 * 3)
p <- format(p, scientific = FALSE)
p

f <- 7

#fdr
p <- 0.0002
```
###Visualization of Main Results
```{r}
#Take The Smooths of Both of our Groups
diff <- difference_smooths(nonlinear$gam,
                           select = "s(age)",
                           by = "fhr",
                           comp = list(fhr = c("FHR", "Control")))

age_seq <- seq(min(merged$age, na.rm = TRUE),
               max(merged$age, na.rm = TRUE),
               length.out = 200)

# Create a new data frame with average covariate values
newdat <- expand.grid(
  age = age_seq,
  fhr = factor(levels(merged$fhr), levels = levels(merged$fhr)),
  sex = factor(levels(merged$sex)[1], levels = levels(merged$sex)),         # hold sex constant
  weekend = factor(levels(merged$weekend)[1], levels = levels(merged$weekend))  # hold weekend constant
)

# Assign one subject ID (for random effects if included)
newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))

#
pred <- predict(nonlinear$gam, newdata = newdat, se.fit = TRUE, exclude = "s(subject_id)")

newdat$fit <- pred$fit
newdat$se <- pred$se.fit
z <- qnorm(0.975)  # 1.96
newdat <- newdat %>%
  mutate(
    lower = fit - z * se,
    upper = fit + z * se
  )

# 6. Plot adjusted smooths for groups with ggplot
sum <- merged %>%
  group_by(filename) %>%
    summarise(
      SRIm = mean(SRI2_scaled, na.rm = TRUE),
      age = mean(age, na.rm = TRUE),
      fhr = first(fhr)
    )


SRIoutput <- ggplot() +
  # Raw data
  geom_point(data = sum,
             aes(x = age, y = SRIm, color = fhr),
             alpha = 0.25, size = 1.2) +
  
  
  # Model predictions
  geom_line(data = newdat,
            aes(x = age, y = fit, color = fhr),
            size = 1.2) +
    geom_ribbon(data = newdat, aes(x = age, ymin = lower, ymax = upper, fill = fhr), alpha = 0.25, color = NA) +
  # Scales
  scale_color_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
  scale_fill_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
  scale_y_continuous(limits = c(60, 100), breaks = seq(60, 100, by = 10)) +
  labs(title = "Observed and Modelled Sleep Regularity by Group",
       x = "Age",
       y = "Sleep Duration (hours)",
       color = "Group",
       fill = "Group") +
  theme_minimal()
SRIoutput



#Differences
diff <- difference_smooths(
  nonlinear, smooth = "s(age)",                          # base label of the smooth
  n = 2000, unconditional = TRUE,
  interval = "simultaneous", level = 0.983,        # or 0.9833 if you insist on Bonferroni across 3 outcomes
  comp = list(fhr = c("FHR", "Control"))
)

SRIdiff <- ggplot(diff, aes(x = age, y = .diff)) +
  geom_hline(yintercept = 0, color = "black", linewidth = 0.8) +
  geom_ribbon(aes(ymin = .lower_ci, ymax = .upper_ci),
              fill = "#B380B3", alpha = 0.4) +
  geom_line(color = "#B380B3", linewidth = 1.3) +
  ggtitle("Difference in Sleep Regularity Index (FHR - Control)") +
  xlab("Age") +
  ylab("Difference in Predicted SRI") +
  theme_minimal() +
  annotate(
    "text",
    x = min(diff$age, na.rm = TRUE),
    y = min(diff$.lower_ci, na.rm = TRUE),
    label = as.character(
      as.expression(
        bquote(bold(italic("p"))[Bonf.] ~ "< 0.001")
      )
    ),
    parse = TRUE,
    hjust = 0, vjust = -1, size = 4.2
  )
SRIdiff

SRIoutput <- SRIoutput +
  theme(
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )

SRIdiff <- SRIdiff +
  theme(
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )


library(patchwork)
SRIcombo <- SRIoutput + SRIdiff +
  plot_layout(ncol = 2, widths = c(1, 1)) +
  plot_annotation(
    title = "Sleep Regularity Trajectories and Group Differences",
    theme = theme(
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      plot.margin = margin(15, 15, 15, 15)
    )
  )
SRIcombo

ggsave(
  "SRI_Patchwork.png",
  plot = SRIcombo,
  width = 8.5, height = 6.5, units = "in", dpi = 600,
  bg = "white"
)
```


###Table
```{R}
library(dplyr)
library(flextable)
library(broom.mixed)
library(tibble)

#========================
# FIXED EFFECTS
#========================
mod1 <- broom.mixed::tidy(nonlinear_order$lme,
                          effects = "fixed",
                          conf.int = TRUE)

# remove spline basis coefficients
mod1 <- mod1 %>% filter(!grepl("^Xs", term))

format_model <- function(model_df) {
  model_df %>%
    mutate(
      term = recode(term,
        "X(Intercept)"        = "Intercept",
        "Xfhr2.L"             = "FHR (Group)",
        "XsexFemale"          = "Sex (Female)",
        "XweekendWeekend"     = "Weekend"
      ),
      `b (SE)`   = sprintf("%.2f (%.2f)", estimate, std.error),
      `95% CI`   = sprintf("[%.2f, %.2f]", conf.low, conf.high),
      `p value`  = ifelse(p.value < .001, "<.001", sprintf("%.3f", p.value))
    ) %>%
    select(term, `b (SE)`, `95% CI`, `p value`)
}

tbl_fixed <- format_model(mod1)

#========================
# SMOOTH TERMS
#========================
smooth_table <- as.data.frame(summary(nonlinear_order$gam)$s.table)

tbl_smooth <- smooth_table %>%
  tibble::rownames_to_column("term") %>%
  mutate(
    term = recode(
      term,
      "s(age)"             = "Smooth(Age)",
      "s(age):fhr2FHR"     = "Smooth(Age) Ã— FHR"
    ),
    edf = sprintf("%.2f", edf),
    F   = sprintf("%.2f", F),
    `p value` = ifelse(`p-value` < .001, "<.001", sprintf("%.3f", `p-value`))
  ) %>%
  select(term, edf, F, `p value`)

#========================
# BUILD ONE TABLE
#========================
# Create divider row
divider <- tibble(
  term = "Smooth Terms",
  `b (SE)` = NA,
  `95% CI` = NA,
  `p value` = NA
)

# Rename smooth-term columns to match fixed layout
tbl_smooth_fmt <- tbl_smooth %>%
  rename(`b (SE)` = edf,
         `95% CI` = F)

# Bind everything together
combined_df <- bind_rows(
  tbl_fixed,
  divider,
  tbl_smooth_fmt
)

combined_table <- flextable(combined_df) %>%
  set_caption("Model: Sleep Regularity Index â€” General Additive Model") %>%
  bold(i = nrow(tbl_fixed) + 1, j = 1) %>%   # bold the "Smooth Terms" row
  autofit()

save_as_docx(
  "Model: Sleep Regularity Index â€” GAM" = combined_table,
  path = "SRI_GAM_Table.docx"
)
```


####Group
#####MDD
```{r}
merged_MDD <- subset(merged, group2 %in% c("Control", "MDD Risk"))
merged_MDD$MDD <- droplevels(merged_MDD$group2)
table(merged_MDD$group2)

nonlinear_order <- gamm(
  SRI2_scaled ~ MDD + sex + weekend + s(age, k = 5) +
    s(age, by = MDD, k = 5),  # one smooth per group
  random = list(fid = ~1, subject_id = ~1),
  data = merged_MDD,
  method = "REML"
)

summary(nonlinear_order$gam)
```
######Visualization
```{r}

```


#####BD
```{r}
merged_BD <- subset(merged, group2 %in% c("Control", "BD Risk"))
merged_BD$BD <- droplevels(merged_BD$group2)
table(merged_BD$BD)

m_gamm <- gamm(
  SRI2_scaled ~ BD + sex + weekend +
    s(age, k = 7) +
    s(age, by = BD, k = 7),
  random = list(fid = ~1, subject_id = ~1),
  data = merged_BD,
  method = "REML"
)

m <- m_gamm$gam   # for gratia

summary(m)
```
######Visualization
```{r}

```

