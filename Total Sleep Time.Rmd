---
title: "Trajectories"
author: "Zachary"
date: '2025-07-28'
output: html_document
---

# Library & Notes
```{r setup, include=FALSE}
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸ“¦ Data Import & Manipulation
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(haven)       # Read SPSS, SAS, Stata files
library(readr)       # Read CSVs
library(readxl)      # Read Excel files
library(data.table)  # Fast data manipulation
library(dplyr)       # Data manipulation
library(tidyr)       # Data tidying
library(stringr)     # String operations
library(purrr)       # Functional programming
library(zoo)         # Time series & rolling functions
library(lubridate)   # Dates & times
library(fuzzyjoin)   # Fuzzy matching joins

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸ“Š Modeling & Statistics
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(lme4)        # Mixed-effects models
library(lmerTest)    # p-values for lmer
library(coxme)       # Cox mixed-effects models
library(survival)    # Survival analysis
library(MuMIn)       # Model selection & RÂ²
library(lsmeans)     # Least-squares means (now emmeans)
library(mgcv)        # Generalized Additive Models
library(gratia)      # GAM diagnostics & visualization
library(gamm4)       # GAMM fitting
library(patchwork)

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸ“‘ Tables & Reporting
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(broom)       # Tidy model output
library(pander)      # Pretty markdown tables
library(apaTables)   # APA-style tables
library(flextable)   # Formatted tables
library(officer)     # Export to Word/PowerPoint
library(webshot2)    # Save HTML tables/images

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸŽ¨ Plotting & Visualization
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(ggplot2)     # General plotting
```

#Data Setup
##Cleaning Actirgaph and Merging
```{r}
# setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
  setwd("C:/Users/zacha/OneDrive/Documents/Code/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git/data") # Home Computer\




FOR <- readr::read_csv("FOR2.csv", col_types = cols(.default = col_character()))
Night <- readr::read_csv("part4_nightsummary_sleep_cleaned.csv", col_types = cols(.default = col_character()))
NightM <- read_excel("motionloggerdata.xlsx")

#Fix clerical errors

Night$calendar_date <- as.Date(Night$calendar_date)
Night <- Night %>%
  mutate(
    calendar_date = case_when(
      filename == "800-0250-464_left wrist_068218_2025-12-01 14-08-11.bin" ~ calendar_date + 120,
      TRUE ~ calendar_date
    )
  )
Night$filename <- gsub("^800-304", "800-0304", Night$filename)
Night$filename <- gsub("^800-0066-106", "800-0065-106", Night$filename) # double check
Night$filename <- gsub("^800-0298-507", "800-0298-570", Night$filename)
Night$filename <- gsub("^800-0221-441", "800-0221-411", Night$filename)
Night$filename <- gsub("^0037062", "800-0037-062", Night$filename)

Night$Subject_ID <- substr(Night$filename, 1, 12)
Night <- Night %>%
  dplyr::rename(Assessment_Date = calendar_date)
Night <- Night %>% 
  filter(!str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))

##Filtering bad extraction. Filtering a weird GGIR duplication?     
bin_files_to_remove <- c(
  "8000156273_left wrist_060381_2024-11-05 12-04-08_partial.bin"
)
Night <- Night %>%
  filter(!filename %in% bin_files_to_remove)
Night <- Night %>%
  filter(
    !(filename == "800-0250-464_left wrist_068218_2025-12-01 14-08-11.bin" &
    sleepparam == "spt_crude_estimate")
  )


Night <- Night %>%
  mutate(Subject_ID = gsub("^800-(\\d{3})-(\\d+)_$", "800-0\\1-\\2", Subject_ID))
Night$Subject_ID <- gsub("-", "", Night$Subject_ID)
Night$Subject_ID <- gsub("[a-zA-Z]", "", Night$Subject_ID)
Night$Subject_ID <- gsub("_", "", Night$Subject_ID)
FOR$Subject_ID <- gsub("-", "", as.character(FOR$subject_id))
setDT(Night)
setDT(FOR)

##GeneACTIV Merging
Night$geneactiv <- 1
FOR[, Assessment_Date := as.Date(assessment_date)]
FOR$Assessment_Date_FOR <- FOR$Assessment_Date
Night[, Assessment_Date := as.Date(Assessment_Date)]  # redundant if already Date
Night$Assessment_Date_Night <- Night$Assessment_Date
merged1 <- Night[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged1[, diffdays := (as.numeric(difftime(Assessment_Date_Night, Assessment_Date_FOR, units = "days")))]

merged1 <- merged1 %>% filter(diffdays >= 0 & diffdays <= 100)

two <- merged1[(Subject_ID %in% c(8000038204, 8000114479))]

##Motion Logger Merging
NightM <- NightM %>%
  mutate(filename = paste0(ID, "motionlogg"))
NightM$weekday <- NightM$eday
NightM <- NightM %>% 
  filter(!str_detect(Subject_ID, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))
setDT(NightM)
NightM[, Assessment_Date := as.Date(sdate)]
NightM$Assessment_date_nightM <- NightM$Assessment_Date
merged2 <- NightM[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged2[, diffdays := abs(as.numeric(difftime(Assessment_date_nightM, Assessment_Date_FOR, units = "days")))]
merged2 <- merged2 %>% filter(diffdays >= 0 & diffdays <= 100)
merged2$motionlogger <- 1

#Combination of Motion and GeneActiv
merged <- rbindlist(list(merged1, merged2), fill = TRUE)
length(unique(merged$subject_id))
```

##Labeling & Filtering
```{r}

#Creating FHR Variable and Weekend
merged <- merged %>%
  mutate(fhr = ifelse(group %in% c(1, 2, 3), 1, 0))

merged$weekend <- ifelse(merged$weekday %in% 
                         c("Sat", "Saturday", "Sun", "Sunday"), 1, 0)

#Labeling
merged$fhr <- factor(merged$fhr,
                       levels = c(0, 1),
                       labels = c("Control", "FHR"))
merged$group <- factor(merged$group,
                       levels = c(0, 1, 2, 3),
                       labels = c("Control", "MDD Risk", "BD Risk", "Psy Risk"))
merged$sex <- factor(merged$sex,
                       levels = c(0, 1),
                       labels = c("Male", "Female"))
merged$weekend <- factor(merged$weekend,
                         levels = c(0, 1),
                         labels = c("Weekday", "Weekend"))
merged$age <- as.numeric(merged$age)
merged$subject_id <- as.factor(merged$subject_id)
merged$SleepDurationInSpt <- as.numeric(merged$SleepDurationInSpt)

#Remove Psy Risk and Those without gruop
merged <- merged %>% filter(age < 25 & age >= 8)
merged <- merged %>% filter(group != 'Psy Risk')

table(merged$group)

merged <- merged %>%
  mutate(
    mdd = factor(ifelse(group == "MDD Risk", 1, 0), levels = c(0, 1)),
    bd  = factor(ifelse(group == "BD Risk", 1, 0), levels = c(0, 1))
  )

merged <- merged %>%
  group_by(filename) %>%   # or filename
  filter(
    sum(weekend == "Weekend", na.rm = TRUE) >= 1,
    sum(weekend == "Weekday", na.rm = TRUE) >= 3
  ) %>%
  ungroup()
```

#Main Analysis
##Linear
```{r}
mod1 <- lmer(SleepDurationInSpt ~ fhr*age + sex + weekend + (1|fid/subject_id), data = merged)
summary(mod1)
resid_mod1 <- resid(mod1)
qqnorm(resid_mod1)
hist(resid_mod1, breaks = 40, main = "Histogram of Residuals", xlab = "Residuals")

mod2 <- lmer(SleepDurationInSpt ~ group*age + sex + weekend + (1|fid/subject_id), data = merged)
summary(mod2)
```

###Table
```{r}
apa_format <- function(model){
  tidy(model, effects = "fixed", conf.int = TRUE) %>%
    mutate(
      Predictor = recode(term,
        "(Intercept)"     = "Intercept",
        "fhrFHR"          = "FHR",
        "age"             = "Age",
        "fhrFHR:age"      = "FHR Ã— Age",
        "groupMDD Risk"            = "MDD",
        "groupBD Risk"             = "BD",
        "groupMDD Risk:age"        = "Age Ã— MDD",
        "groupBD Risk:age"         = "Age Ã— BD",
        "sexFemale"       = "Sex (Female)",
        "weekendWeekend"  = "Weekend"
      ),
      `b (SE)` = sprintf("%.2f (%.2f)", estimate, std.error),
      CI = sprintf("[%.2f, %.2f]", conf.low, conf.high),
      p = ifelse(p.value < .001, "<.001", sprintf("%.3f", p.value))
    ) %>%
    select(Predictor, `b (SE)`, CI, p)
}

m1 <- apa_format(mod1)
m2 <- apa_format(mod2)

combined <- full_join(
  m1 %>% rename(b1 = `b (SE)`, CI1 = CI, p1 = p),
  m2 %>% rename(b2 = `b (SE)`, CI2 = CI, p2 = p),
  by = "Predictor"
)

order_terms <- c(
  "Intercept",
  "FHR",
  "Age",
  "FHR Ã— Age",
  "MDD",
  "BD",
  "Age Ã— MDD",
  "Age Ã— BD",
  "Sex (Female)",
  "Weekend"
)

combined <- combined %>%
  mutate(Predictor = factor(Predictor, levels = order_terms)) %>%
  arrange(Predictor) %>%
  replace(is.na(.), "")


ft <- flextable(combined) %>%
  set_header_labels(
    Predictor = "Predictor",
    b1 = "Î² (SE)",
    CI1 = "95% CI",
    p1 = "p",
    b2 = "Î² (SE)",
    CI2 = "95% CI",
    p2 = "p"
  ) %>%
  add_header_row(
    values = c("", "Model 1", "Model 1", "Model 1",
                  "Model 2", "Model 2", "Model 2"),
    colwidths = c(1,1,1,1,1,1,1)
  ) %>%
  merge_h(part = "header") %>%
  autofit() %>%
  align(j = 2:7, align = "center") %>%
  align(j = 1, align = "left") %>%
  bold(part = "header")

ft


save_as_docx(
  "Linear Mixed Models Predicting TST" = ft,
  path = "TST_TwoModel_APA_Table.docx"
)
```


###Visualization
```{r}
#Graph 1
age_seq <- seq(
  min(merged$age, na.rm = TRUE),
  max(merged$age, na.rm = TRUE),
  length.out = 200
)

# 1. Prediction dataframe
newdat <- expand.grid(
  age = age_seq,
  fhr = levels(merged$fhr),
  sex = levels(merged$sex)[1],
  weekend = levels(merged$weekend)[1]
) %>%
  mutate(
    fhr = factor(fhr, levels = levels(merged$fhr)),
    sex = factor(sex, levels = levels(merged$sex)),
    weekend = factor(weekend, levels = levels(merged$weekend))
  )

# 2. Add valid random-effect IDs
newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))
newdat$fid        <- factor(merged$fid[1], levels = levels(merged$fid))

# 3. Predict SRI, excluding RE if needed
pred <- predict(
  mod1,
  newdata = newdat,
  re.form = NA,       # <--- KEY FIX
  se.fit = TRUE
)


newdat$fit <- pred$fit

sum <- merged %>%
  group_by(filename) %>%
  summarise(
    TSTm = mean(SleepDurationInSpt, na.rm = TRUE),
    age  = mean(age, na.rm = TRUE),
    fhr  = first(fhr)
  )

TSToutput1 <- ggplot() +
  geom_point(data = sum,
             aes(x = age, y = TSTm, color = fhr),
             alpha = 0.25, size = 1.2) +
  geom_line(data = newdat,
            aes(x = age, y = fit, color = fhr),
            size = 1.2) +
  scale_color_manual(values = c("Control" = "lightblue", "FHR" = "darkorange")) +
  scale_y_continuous(limits = c(4,10), breaks = seq(4,10,2)) +
  labs(
    title = "Model 1",
    x = "Age",
    y = "Total Sleep Time",
    color = "Group"
  ) +
  theme_minimal()
TSToutput1

#Graph 2
age_seq <- seq(
  min(merged$age, na.rm = TRUE),
  max(merged$age, na.rm = TRUE),
  length.out = 200
)

# 1. Prediction dataframe
newdat <- expand.grid(
  age     = age_seq,
  group   = c("Control", "MDD Risk", "BD Risk"),        # <-- CORRECT
  sex     = levels(merged$sex)[1],       # hold constant
  weekend = levels(merged$weekend)[1]    # hold constant
)

# Ensure factor structure matches the model
newdat <- newdat %>%
  mutate(
    group   = factor(group,   levels = levels(merged$group)),
    sex     = factor(sex,     levels = levels(merged$sex)),
    weekend = factor(weekend, levels = levels(merged$weekend)),
    fid = merged$fid[1],               # valid RE levels
    subject_id = merged$subject_id[1]
  )

# 2. Add valid random-effect IDs
newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))
newdat$fid        <- factor(merged$fid[1], levels = levels(merged$fid))

# 3. Predict SRI, excluding RE if needed
pred <- predict(
  mod2,
  newdata = newdat,
  re.form = NA,    # fixed effects only
  se.fit  = FALSE
)

newdat$fit <- pred

sum <- merged %>%
  filter(group %in% c("Control", "MDD Risk", "BD Risk")) %>%   # keep only these
  group_by(filename) %>%
  summarise(
    TSTm  = mean(SleepDurationInSpt, na.rm = TRUE),
    age   = mean(age, na.rm = TRUE),
    group = first(group)
  )


TSToutput2 <- ggplot() +
  geom_point(data = sum,
             aes(x = age, y = TSTm, color = group),
             alpha = 0.25, size = 1.2) +
  geom_line(data = newdat,
            aes(x = age, y = fit, color = group),
            size = 1.2) +
  scale_color_manual(values = c(
    "Control" = "lightblue",
    "MDD Risk"     = "darkorange",
    "BD Risk"      = "darkred"
  )) +
  scale_y_continuous(limits = c(4,10), breaks = seq(4,10,2)) +
  labs(
    title = "Model 2",
    x = "Age",
    y = "Sleep Regularity",
    color = "Group"
  ) +
  theme_minimal()
TSToutput2

TSToutput1 <- TSToutput1 + theme(legend.position = "top") + theme(legend.title = element_blank()) +
  theme(
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )

TSToutput2 <- TSToutput2 + ylab(NULL) + theme(legend.position = "top") + theme(legend.title = element_blank()) +
  theme(
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )

TSTcombo <- TSToutput1 + TSToutput2 +
  plot_layout(ncol = 2, widths = c(1, 1)) +
  plot_annotation(
    title = "Observed and Modelled Total Sleep Time Trajectories by Group",
    theme = theme(
      plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.margin = margin(15, 15, 15, 15)
    )
  )
TSTcombo

ggsave(
  "TST_Patchwork_Linear.png",
  plot = TSTcombo,
  width = 8.5, height = 6.5, units = "in", dpi = 600,
  bg = "white"
)
```

##Nonlinear
```{r}
#This will show difference in smooth factors
merged$fhr2 <- ordered(merged$fhr, levels = c("Control", "FHR"))
linear <- lmer(SleepDurationInSpt ~ fhr2*age + sex + weekend + (1|fid/subject_id), data = merged)

nonlinear <- gamm(
  SleepDurationInSpt ~ fhr + sex + weekend + 
    s(age, by = fhr, k = 5),
  random = list(fid = ~1, subject_id = ~1),
  data = merged,
  method = "REML"
)

nonlinear_order <- gamm(
  SleepDurationInSpt ~ fhr2 + sex + weekend + s(age, k = 5) + 
    s(age, by = fhr2, k = 5),
  random = list(fid = ~1, subject_id = ~1),
  data = merged,
  method = "REML"
)
summary(nonlinear_order$gam)


gam.check(nonlinear_order$gam)


#BIC(linear, nonlinear_order)

AIC(linear, nonlinear_order$lme)
BIC(linear, nonlinear_order$lme)
p_tst <- 0.0112
pbonf_tst <- 0.0112*3


gam.check(nonlinear_order$gam)
draw(nonlinear_order)
```

###Visualization
####Graph A
```{r}
#Take The Smooths of Both of our Groups
diff <- difference_smooths(nonlinear$gam,
                           select = "s(age)",
                           by = "fhr",
                           comp = list(fhr = c("FHR", "Control")))





# 5. Create predicted trajectories by group for ggplot

# Create new data for prediction (age sequence)
age_seq <- seq(min(merged$age, na.rm = TRUE),
               max(merged$age, na.rm = TRUE),
               length.out = 200)

# Create a new data frame with average covariate values
newdat <- expand.grid(
  age = age_seq,
  fhr = factor(levels(merged$fhr), levels = levels(merged$fhr)),
  sex = factor(levels(merged$sex)[1], levels = levels(merged$sex)),         # hold sex constant
  weekend = factor(levels(merged$weekend)[1], levels = levels(merged$weekend))  # hold weekend constant
)

# Assign one subject ID (for random effects if included)
newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))

pred <- predict(nonlinear$gam, newdata = newdat, se.fit = TRUE, exclude = "s(subject_id)")

newdat$fit <- pred$fit
 newdat$se <- pred$se.fit
 z <- qnorm(0.975)  # 1.96
 newdat <- newdat %>%
   mutate(
     lower = fit - z * se,
     upper = fit + z * se
   )

# 6. Plot adjusted smooths for groups with ggplot
sum <- merged %>%
  group_by(filename) %>%
    summarise(
      TSTm = mean(SleepDurationInSpt, na.rm = TRUE),
      age = mean(age, na.rm = TRUE),
      fhr = first(fhr)
    )


TSToutput <- ggplot() +
  # Raw data
  geom_point(data = sum,
             aes(x = age, y = TSTm, color = fhr),
             alpha = 0.25, size = 1.2) +
  
  
  # Model predictions
  geom_line(data = newdat,
            aes(x = age, y = fit, color = fhr),
            size = 1.2) +
     geom_ribbon(data = newdat, aes(x = age, ymin = lower, ymax = upper, fill = fhr), alpha = 0.25, color = NA) +
  
  # Scales
  scale_color_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
  scale_fill_manual(values = c("Control" = "#6699FF", "FHR" = "#FF6666")) +
  scale_y_continuous(limits = c(4, 10), breaks = seq(4, 10, by = 2)) +
  
  labs(title = "Observed and Modelled Sleep Duration by Group",
       x = "Age",
       y = "Sleep Duration (hours)",
       color = "Group",
       fill = "Group") + 
  annotate(
  "text",
  x = min(newdat$age) + 0.5,
  y = 4.2,
  label = expression(bold(italic("p"))[BONF.] == 0.033),
  parse = TRUE,
  hjust = 0
) +
  theme_minimal()
TSToutput
```


####Graph B
```{r}
#Differences
bands <- (confint(nonlinear_order$gam, "s(age):fhr2FHR", n = 20000, level = 0.95, type = "simultaneous"))
draw(bands)

(confint(nonlinear_order$gam, "s(age):fhr2FHR", level = 0.95, type = "simultaneous"))


TSTdiff <- ggplot(bands, aes(x = age, y = .estimate)) +
  
  geom_hline(yintercept = 0, linewidth = 0.8) + 
  
  scale_x_continuous(
  limits = c(8, 25),
  breaks = seq(8, 25, by = 5)
) +
  # ---- Insignificant: 8 â†’ 18.32 ----
  geom_ribbon(
    data = subset(bands, age >= 8 & age < 20.6),
    aes(ymin = .lower_ci, ymax = .upper_ci),
    fill  = "#B380B3",
    alpha = 0.25
  ) +
  
      # ---- Significant: 10 â†’ 14.04 ----
  geom_ribbon(
    data = subset(bands, age >= 20.6 & age <= 20.79),
    aes(ymin = .lower_ci, ymax = .upper_ci),
    fill  = "#8E4A8E",
    alpha = 0.5
  ) +
  
  
    # ---- Insignificant: 8 â†’ 18.32 ----
  geom_ribbon(
    data = subset(bands, age > 20.79 & age <= 25),
    aes(ymin = .lower_ci, ymax = .upper_ci),
    fill  = "#B380B3",
    alpha = 0.25
  ) +
  
  geom_line(linewidth = 1.3) +

  labs(
    title = "Age-varying difference in total sleep time",
    x = "Age (years)",
    y = "Difference in predicted total sleep time"
  ) +

  theme_minimal()

TSTdiff
```


####Graph combine
```{r}
TSToutput <- TSToutput +
  theme(
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )

TSTdiff <- TSTdiff +
  theme(
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )


library(patchwork)
TSTcombo <- TSToutput + TSTdiff +
  plot_layout(ncol = 2, widths = c(1, 1)) +
  plot_annotation(
    title = "Sleep Duration Trajectories and Group Differences",
    theme = theme(
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      plot.margin = margin(15, 15, 15, 15)
    )
  )

TSTcombo

ggsave(
  "TST_Patchwork.png",
  plot = TSTcombo,
  width = 8.5, height = 6.5, units = "in", dpi = 600,
  bg = "white"
)
```

###Table output
```{r}
library(dplyr)
library(flextable)
library(broom.mixed)
library(tibble)

#========================
# FIXED EFFECTS
#========================
mod1 <- broom.mixed::tidy(nonlinear_order$lme,
                          effects = "fixed",
                          conf.int = TRUE)

# remove spline basis coefficients
mod1 <- mod1 %>% filter(!grepl("^Xs", term))

format_model <- function(model_df) {
  model_df %>%
    mutate(
      term = recode(term,
        "X(Intercept)"        = "Intercept",
        "Xfhr2.L"             = "FHR (Group)",
        "XsexFemale"          = "Sex (Female)",
        "XweekendWeekend"     = "Weekend"
      ),
      `b (SE)`   = sprintf("%.2f (%.2f)", estimate, std.error),
      `95% CI`   = sprintf("[%.2f, %.2f]", conf.low, conf.high),
      `p value`  = ifelse(p.value < .001, "<.001", sprintf("%.3f", p.value))
    ) %>%
    select(term, `b (SE)`, `95% CI`, `p value`)
}

tbl_fixed <- format_model(mod1)

#========================
# SMOOTH TERMS
#========================
smooth_table <- as.data.frame(summary(nonlinear_order$gam)$s.table)

tbl_smooth <- smooth_table %>%
  tibble::rownames_to_column("term") %>%
  mutate(
    term = recode(
      term,
      "s(age)"             = "Smooth(Age)",
      "s(age):fhr2FHR"     = "Smooth(Age) Ã— FHR"
    ),
    edf = sprintf("%.2f", edf),
    F   = sprintf("%.2f", F),
    `p value` = ifelse(`p-value` < .001, "<.001", sprintf("%.3f", `p-value`))
  ) %>%
  select(term, edf, F, `p value`)

#========================
# BUILD ONE TABLE
#========================
# Create divider row
divider <- tibble(
  term = "Smooth Terms",
  `b (SE)` = NA,
  `95% CI` = NA,
  `p value` = NA
)

# Rename smooth-term columns to match fixed layout
tbl_smooth_fmt <- tbl_smooth %>%
  rename(`b (SE)` = edf,
         `95% CI` = F)

# Bind everything together
combined_df <- bind_rows(
  tbl_fixed,
  divider,
  tbl_smooth_fmt
)

combined_table <- flextable(combined_df) %>%
  set_caption("Model: Total Sleep Time â€” General Additive Model") %>%
  bold(i = nrow(tbl_fixed) + 1, j = 1) %>%   # bold the "Smooth Terms" row
  autofit()

save_as_docx(
  "Model: Total Sleep Time â€” GAM" = combined_table,
  path = "TST_GAM_Table.docx"
)

```


###Basis fucntions
```{r}
b <- gam(
  SleepDurationInSpt ~ fhr + sex + weekend + s(age, by = fhr, k = 5),
  data = merged,
  fit = FALSE
)

X <- b$X
colnames(X) <- paste0("basis_", seq_len(ncol(X)))

basis_df <- data.frame(
  age = merged$age,
  fhr = merged$fhr,
  X
)

basis_long <- basis_df %>%
  pivot_longer(starts_with("basis_"),
               names_to = "basis",
               values_to = "value") %>%
  filter(!basis %in% paste0("basis_", 1:4))


p <- ggplot() +
  geom_line(
    data = basis_long,
    aes(x = age, y = value + 7.75, group = basis, color = basis),
    linewidth = 0.9
  ) +
  geom_point(
    data = sum,
    aes(x = age, y = TSTm, color = fhr),
    alpha = 0.25, size = 1.2
  ) +
  facet_wrap(~fhr) +
  theme_minimal(base_size = 16) +
  labs(
    title = "Basis functions and observed data for TST",
    x = "Age",
    y = "Total Sleep Time (hours)"
  )

ggsave("basis_tst_plot.png", p, width = 12, height = 6, dpi = 300)



```

#Exploration
```{r}
newdat <- expand.grid(
  age = 18,
  fhr2 = levels(merged$fhr2),
  sex = levels(merged$sex)[1],
  weekend = levels(merged$weekend)[1]
)

# Make sure factor levels match
newdat$fhr2   <- factor(newdat$fhr2, levels = levels(merged$fhr2))
newdat$sex    <- factor(newdat$sex,  levels = levels(merged$sex))
newdat$weekend <- factor(newdat$weekend, levels = levels(merged$weekend))

# Predict from GAM (population-level)
pred_18 <- predict(
  nonlinear_order$gam,
  newdata = newdat,
  type = "response",
  se.fit = TRUE
)

# Combine with newdat
out <- cbind(newdat, fit = pred_18$fit, se = pred_18$se.fit)

out
```





