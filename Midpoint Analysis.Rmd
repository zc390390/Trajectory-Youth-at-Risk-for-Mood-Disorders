---
title: "Trajectories"
author: "Zachary"
date: '2025-07-28'
output: html_document
---

  
# Library & Notes
```{r setup, include=FALSE}
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ## ðŸ“¦ Data Import & Manipulation
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  library(haven)       # Read SPSS, SAS, Stata files
  library(readr)       # Read CSVs
  library(readxl)      # Read Excel files
  library(data.table)  # Fast data manipulation
  library(dplyr)       # Data manipulation
  library(tidyr)       # Data tidying
  library(stringr)     # String operations
  library(purrr)       # Functional programming
  library(zoo)         # Time series & rolling functions
  library(lubridate)   # Dates & times
  library(fuzzyjoin)   # Fuzzy matching joins
  
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ## ðŸ“Š Modeling & Statistics
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  library(lme4)        # Mixed-effects models
  library(lmerTest)    # p-values for lmer
  library(coxme)       # Cox mixed-effects models
  library(survival)    # Survival analysis
  library(MuMIn)       # Model selection & RÂ²
  library(lsmeans)     # Least-squares means (now emmeans)
  library(mgcv)        # Generalized Additive Models
  library(gratia)      # GAM diagnostics & visualization
  library(gamm4)       # GAMM fitting
  
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ## ðŸ“‘ Tables & Reporting
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  library(broom)       # Tidy model output
  library(pander)      # Pretty markdown tables
  library(apaTables)   # APA-style tables
  library(flextable)   # Formatted tables
  library(officer)     # Export to Word/PowerPoint
  library(webshot2)    # Save HTML tables/images
  
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ## ðŸŽ¨ Plotting & Visualization
  ## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  library(ggplot2)     # General plotting
```

#Load Data
```{r}
setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
# setwd("C:/Users/zachh/Documents/Code/git/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git") # Home Computer

FOR <- readr::read_csv("FOR.csv", col_types = cols(.default = col_character())) 
Night <- readr::read_csv("part4_nightsummary_sleep_cleaned.csv", col_types = cols(.default = col_character())) 
NightM <- read_excel("motionloggerdata.xlsx")
```


#Non-Mean Exploration
```{r}
Night$Subject_ID <- substr(Night$filename, 1, 12)
Night$Assessment_Date <- str_extract(Night$filename, "\\d{4}-\\d{2}-\\d{2}")
Night <- Night %>% 
  filter(!str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))

##Why are we removing this         
bin_files_to_remove <- c(
  "8000103174_left wrist_068158_2025-06-03 10-40-36.bin",
  "8000156273_left wrist_060381_2024-11-05 12-04-08_partial.bin",
  "8000156273_left wrist_060381_2024-11-05 12-27-40.bin",
  "800304581_right wrist_060843_2024-11-05 13-16-09.bin",
  "800304582__060365_2024-11-05 12-03-44.bin",
  "800304582__060365_2024-11-05 12-28-01.bin"
)
Night <- Night %>%
  filter(!filename %in% bin_files_to_remove)
Night <- Night %>%
  mutate(Subject_ID = gsub("^800-(\\d{3})-(\\d+)_$", "800-0\\1-\\2", Subject_ID))
Night$Subject_ID <- gsub("-", "", Night$Subject_ID)
Night$Subject_ID <- gsub("[a-zA-Z]", "", Night$Subject_ID)
Night$Subject_ID <- gsub("_", "", Night$Subject_ID)
FOR$Subject_ID <- gsub("-", "", as.character(FOR$subject_id))
setDT(Night)
setDT(FOR)

##GeneACTIV Merging
Night$geneactiv <- 1
FOR[, Assessment_Date := as.Date(assessment_date)]
FOR$Assessment_Date_FOR <- FOR$Assessment_Date
Night[, Assessment_Date := as.Date(Assessment_Date)]  # redundant if already Date
Night$Assessment_Date_Night <- Night$Assessment_Date
merged1 <- Night[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged1[, diffdays := abs(as.numeric(difftime(Assessment_Date_Night, Assessment_Date_FOR, units = "days")))]
merged1 <- merged1 %>% filter(diffdays <= 179)
two <- merged1[(Subject_ID %in% c(8000038204, 8000114479))]

##Motion Logger Merging
NightM <- NightM %>%
  mutate(filename = paste0(ID, "motionlogg"))
NightM$weekday <- NightM$eday
NightM <- NightM %>% 
  filter(!str_detect(Subject_ID, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))
setDT(NightM)
NightM[, Assessment_Date := as.Date(sdate)]
NightM$Assessment_date_nightM <- NightM$Assessment_Date
merged2 <- NightM[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged2[, diffdays := abs(as.numeric(difftime(Assessment_date_nightM, Assessment_Date_FOR, units = "days")))]
merged2 <- merged2 %>% filter(diffdays <= 179)
merged2$motionlogger <- 1

#Combination of Motion and GeneActiv
merged <- rbindlist(list(merged1, merged2), fill = TRUE)
```


#Midpoint
```{r message=FALSE, warning=FALSE}
#Setup
merged$sleeponset <- as.numeric(merged$sleeponset)
merged$wakeup <- as.numeric(merged$wakeup)

merged$midpoint <- merged$sleeponset + ((merged$wakeup - merged$sleeponset)/2)
```



#Data Setup
##Labeling & Filtering
```{r}

#Creating FHR Variable and Weekend
merged <- merged %>%
  mutate(fhr = ifelse(group %in% c(1, 2, 3), 1, 0))

merged$weekend <- ifelse(merged$weekday %in% 
                         c("Sat", "Saturday", "Sun", "Sunday"), 1, 0)

#Labeling
merged$fhr <- factor(merged$fhr,
                       levels = c(0, 1),
                       labels = c("Control", "FHR"))
merged$group <- factor(merged$group,
                       levels = c(0, 1, 2, 3),
                       labels = c("Control", "MDD Risk", "BD Risk", "Psy Risk"))
merged$sex <- factor(merged$sex,
                       levels = c(0, 1),
                       labels = c("Male", "Female"))
merged$weekend <- factor(merged$weekend,
                         levels = c(0, 1),
                         labels = c("Weekday", "Weekend"))
merged$age <- as.numeric(merged$age)
merged$subject_id <- as.factor(merged$subject_id)
merged$SleepDurationInSpt <- as.numeric(merged$SleepDurationInSpt)
merged$fid <- factor(merged$fid)


#Remove Psy Risk and Those without gruop
merged <- merged %>% filter(age >= 8)
merged <- merged %>% filter(group != 'Psy Risk')

merged <- merged %>%
  mutate(
    mdd = factor(ifelse(group == "MDD Risk", 1, 0), levels = c(0, 1)),
    bd  = factor(ifelse(group == "BD Risk", 1, 0), levels = c(0, 1))
  )

table(merged$group)
```

#Main Analysis
##Timing
```{r}
ggplot

linear <- lmer(midpoint ~ fhr*age + sex + weekend + (1|fid/subject_id), data = merged)
summary(linear)



p <- (0.0105*3)
print(p)
confint(linear, method = "profile")


linear_exploration <- lmer(midpoint ~ mdd*age + bd*age + sex + weekend + (1|fid/subject_id), data = merged)
summary(linear_exploration)
p_mdd <- (4.5e-15*3)
p_bd <- (0.000573*3)
print(paste0("MDD P = ", p_mdd, "  BD P = ", p_bd))
confint(linear_exploration, method = "profile")
```

###Table output
####Onset
```{r}
mod1 <- broom.mixed::tidy(linear, effects = "fixed", conf.int = TRUE)
mod2 <- broom.mixed::tidy(linear_exploration, effects = "fixed", conf.int = TRUE)

format_model <- function(model_df) {
  model_df %>%
    mutate(
      term = recode(term,
        "(Intercept)" = "Intercept",
        "fhrFHR" = "FHR (Group)",
        "age" = "Age",
        "sexFemale" = "Sex (Female)",
        "weekendWeekend" = "Weekend",
        "fhrFHR:age" = "FHR Ã— Age",
        "mdd1" = "MDD Risk",
        "bd1"  = "BD Risk",
        "psy1" = "Psy Risk",
        "mdd1:age" = "MDD Ã— Age",
        "age:bd1"  = "BD Ã— Age"
      ),
      `b (SE)` = sprintf("%.2f (%.2f)", estimate, std.error),
      `95% CI` = sprintf("[%.2f, %.2f]", conf.low, conf.high),
      p = ifelse(p.value < 0.001, "<.001", sprintf("%.3f", p.value))
    ) %>%
    select(term, `b (SE)`, `95% CI`, p)
}

m1_table <- format_model(mod1)
m2_table <- format_model(mod2)

apa_table <- full_join(m1_table, m2_table, by = "term", suffix = c("_Model1", "_Model2")) %>%
  arrange(match(term,
    c("Intercept", "FHR (Group)", "MDD Risk", "BD Risk", "Psy Risk",
      "Age", "Sex (Female)", "Weekend",
      "FHR Ã— Age", "MDD Ã— Age", "BD Ã— Age", "Psy Ã— Age")
  )) %>%
  mutate(across(everything(), ~replace_na(., "")))

# Build flextable --------------------------------------------------------
ft <- flextable(apa_table)

ft <- set_header_labels(
  ft,
  term = "Predictor",
  `b (SE)_Model1` = "b (SE)",
  `95% CI_Model1` = "95% CI",
  p_Model1 = "p",
  `b (SE)_Model2` = "b (SE)",
  `95% CI_Model2` = "95% CI",
  p_Model2 = "p"
) |>
  theme_booktabs() |>
  autofit() |>
  align(align = "center", part = "all") |>
  bold(part = "header") |>
  fontsize(size = 11, part = "all")

# ðŸ”¹ Add the grouped model header row
ft <- add_header_row(
  ft,
  values = c("", "Model 1", "Model 2"),
  colwidths = c(1, 3, 3)   # 1 for Predictor, then 3 for each model
)

ft

setwd("outputs")
save_as_docx(ft, path = "Midpoint_APA_Table.docx")
```


###Visualize Linear
####Onset
```{r}
age_seq <- seq(min(merged$age, na.rm = TRUE),
               max(merged$age, na.rm = TRUE),
               length.out = 100)

newdat <- expand.grid(
  age = age_seq,
  fhr = factor(levels(merged$fhr), levels = levels(merged$fhr)),
  sex = factor(levels(merged$sex)[1], levels = levels(merged$sex)),         # hold constant
  weekend = factor(levels(merged$weekend)[1], levels = levels(merged$weekend)) # hold constant
)

newdat$fid        <- factor(levels(merged$fid)[1], levels = levels(merged$fid))
newdat$subject_id <- factor(levels(merged$subject_id)[1], levels = levels(merged$subject_id))

newdat$fit <- predict(linear, newdata = newdat, re.form = NA, allow.new.levels = TRUE)

sum <- merged %>%
  group_by(filename) %>%
    summarise(
      MIDm = mean(midpoint, na.rm = TRUE),
      age = mean(age, na.rm = TRUE),
      fhr = first(fhr)
    )

yep <- ggplot(newdat, aes(x = age, y = fit, color = fhr, fill = fhr)) +
  # predicted line
  geom_line(linewidth = 1.2) +
  # raw data points for reference (optional)
  geom_point(
    data = sum,
    aes(x = age, y = MIDm, color = fhr),
    alpha = 0.15,
    size = 1.2,
    inherit.aes = FALSE
  ) +
  labs(
    x = "Age (years)",
    y = "Sleep Onset (Time)",
    color = "Group",
    fill  = "Group",
    title = "Model 1"
  ) + 
  # ðŸ”¹ Custom y-axis from 18 (6 PM) to 30 (6 AM next day)
  scale_y_continuous(
    limits = c(24, 32),
    breaks = seq(24, 32, by = 2),
    labels = c("12:00 PM", "2:00 AM",
               "4:00 AM", "6:00 AM", "8:00 AM")
  ) +
  scale_x_continuous(limits = c(8,22),
                      breaks = seq(8,22, by = 4)) + 
  scale_color_manual(values = c("Control" = "skyblue", "FHR" = "darkorange")) +
  scale_fill_manual(values = c("Control" = "skyblue", "FHR" = "darkorange")) +
  theme_minimal(base_size = 16) +
  theme(
    legend.position = "top",     # ðŸ”¹ move to right side
    legend.title = element_blank(),     # ðŸ”¹ also ensures it's blank
    legend.text  = element_text(size = 10),  # smaller labels
    legend.key.size = unit(0.6, "lines"),    # smaller color keys
    panel.grid.minor = element_blank(),
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5)
  )


##Subanalysis
age_seq <- seq(min(merged$age, na.rm = TRUE),
               max(merged$age, na.rm = TRUE),
               length.out = 100)

# Create valid group combinations
newdat <- bind_rows(
  # Control
  expand.grid(age = age_seq, mdd = 0, bd = 0, psy = 0,
              sex = "Male", weekend = "Weekday"),
  # MDD risk
  expand.grid(age = age_seq, mdd = 1, bd = 0, psy = 0,
              sex = "Male", weekend = "Weekday"),
  # BD risk
  expand.grid(age = age_seq, mdd = 0, bd = 1, psy = 0,
              sex = "Male", weekend = "Weekday")
)

# Rebuild newdat with proper factors
newdat <- newdat %>%
  mutate(
    mdd      = factor(mdd, levels = levels(merged$mdd)),
    bd       = factor(bd,  levels = levels(merged$bd)),
    sex      = factor(sex, levels = levels(merged$sex)),
    weekend  = factor(weekend, levels = levels(merged$weekend)),
    fid        = factor(levels(merged$fid)[1], levels = levels(merged$fid)),
    subject_id = factor(levels(merged$subject_id)[1], levels = levels(merged$subject_id))
  )


# Assign group labels
newdat <- newdat %>%
  mutate(
    group = case_when(
      mdd == 1 ~ "MDD Risk",
      bd  == 1 ~ "BD Risk",
      TRUE     ~ "Control"
    ),
    group = factor(group, levels = c("Control", "MDD Risk", "BD Risk")),
    fid = factor(levels(merged$fid)[1], levels = levels(merged$fid)),
    subject_id = factor(levels(merged$subject_id)[1], levels = levels(merged$subject_id))
  )

newdat$fit <- predict(linear_exploration, newdata = newdat, re.form = NA, allow.new.levels = TRUE)

library(ggplot2)

sum <- merged %>%
  group_by(filename) %>%
    summarise(
      MIDm = mean(midpoint, na.rm = TRUE),
      age = mean(age, na.rm = TRUE),
      group = first(group)
    )

yep2 <- ggplot(newdat, aes(x = age, y = fit, color = group)) +
  geom_line(linewidth = 1.2) +
  labs(
    title = "Model 2",
    x = "Age (years)",
    y = "",   # ðŸ”¹ remove text but keep the axis space
    color = "Group"
  ) +
  geom_point(
    data = sum,
    aes(x = age, y = MIDm, color = group),
    alpha = 0.15,
    size = 1.2,
    inherit.aes = FALSE
  ) +
  scale_y_continuous(
    limits = c(24, 32),
    breaks = seq(24, 32, by = 2),
    labels = c("12:00 PM", "2:00 AM",
               "4:00 AM", "6:00 AM", "8:00 AM")
  ) +
  scale_x_continuous(
    limits = c(8, 22),
    breaks = seq(8, 22, by = 4)
  ) +
  scale_color_manual(
    values = c("Control" = "skyblue",
               "MDD Risk" = "#E69F00",
               "BD Risk"  = "#D55E00")
  ) +
  theme_minimal(base_size = 16) +
  theme(
    legend.position = "top",
    legend.direction = "horizontal",
    legend.box = "horizontal",
    legend.title = element_blank(),
    legend.text  = element_text(size = 11),
    legend.key.size = unit(0.8, "lines"),
    legend.spacing.x = unit(0.8, "lines"),
    legend.spacing.y = unit(0.2, "lines"),
    plot.title = element_text(size = 20, face = "bold", hjust = 0.5),
    panel.grid.minor = element_blank()
  ) +
  guides(color = guide_legend(nrow = 1, byrow = TRUE))

yep2


library(patchwork)
MIDcombo <- yep + yep2 +
  plot_layout(ncol = 2, widths = c(1, 1)) +
  plot_annotation(
    title = "Predicted Sleep Midpoint & Observed Mean Sleep Midpoint",
    theme = theme(
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      plot.margin = margin(15, 15, 15, 15)
    )
  )
MIDcombo

setwd("outputs")
ggsave(
  "Midpoint_Patchwork.png",
  plot = MIDcombo,
  width = 8.5, height = 6.5, units = "in", dpi = 600,
  bg = "white"
)
```

```{r}

ggplot(sum, aes(x = age, y = MIDm)) +
  geom_point(alpha = 0.25, size = 1.3) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5),
              se = TRUE, linewidth = 1.2) +
  labs(
    title = "Relationship Between Age and Sleep Midpoint",
    x = "Age (years)",
    y = "Sleep Midpoint (minutes)"
  ) +
  theme_minimal(base_size = 16)

ggplot(merged, aes(x = midpoint)) +
  geom_histogram(aes(y = ..density..),
                 bins = 40, alpha = 0.6, color = "black") +
  geom_density(linewidth = 1.2) +
  labs(
    title = "Distribution of Sleep Midpoint",
    x = "Sleep Midpoint (minutes)",
    y = "Density"
  ) +
  theme_minimal(base_size = 16)
```







