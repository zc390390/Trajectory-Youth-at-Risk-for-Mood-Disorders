---
title: "Trajectories"
author: "Zachary"
date: '2025-07-28'
output: html_document
---

#1.0 Setup
##1.1 Library
```{r setup, include=FALSE}
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸ“¦ Data Import & Manipulation
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(haven)       # Read SPSS, SAS, Stata files
library(readr)       # Read CSVs
library(readxl)      # Read Excel files
library(data.table)  # Fast data manipulation
library(dplyr)       # Data manipulation
library(tidyr)       # Data tidying
library(stringr)     # String operations
library(purrr)       # Functional programming
library(zoo)         # Time series & rolling functions
library(lubridate)   # Dates & times
library(fuzzyjoin)   # Fuzzy matching joins

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸ“Š Modeling & Statistics
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(lme4)        # Mixed-effects models
library(lmerTest)    # p-values for lmer
library(coxme)       # Cox mixed-effects models
library(survival)    # Survival analysis
library(MuMIn)       # Model selection & RÂ²
library(lsmeans)     # Least-squares means (now emmeans)
library(mgcv)        # Generalized Additive Models
library(gratia)      # GAM diagnostics & visualization
library(gamm4)       # GAMM fitting
library(patchwork)

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸ“‘ Tables & Reporting
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(broom)       # Tidy model output
library(pander)      # Pretty markdown tables
library(apaTables)   # APA-style tables
library(flextable)   # Formatted tables
library(officer)     # Export to Word/PowerPoint
library(webshot2)    # Save HTML tables/images

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## ðŸŽ¨ Plotting & Visualization
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(ggplot2)     # General plotting

library(dplyr)
library(broom.mixed)
library(flextable)
library(officer)
library(dplyr)
library(broom.mixed)
library(flextable)
library(officer)
```

##1.2 Data Load
```{r}
# setwd("C:/Users/hubshmz/Documents/Code/git/data")  # FORBOW computer
  setwd("C:/Users/zacha/OneDrive/Documents/Code/Data")  # Laptop
# setwd("C:/Users/zacha/Documents/RStudio/forbow/git/Data") # Tupper Windows Comp
# setwd("C:/Users/zacha/Documents/forbow/code/git/data") # Home Computer\

FOR <- readr::read_csv("analytic-zach1.csv", col_types = cols(.default = col_character()))
Night <- readr::read_csv("part4_nightsummary_sleep_cleaned.csv", col_types = cols(.default = col_character()))
NightM <- read_excel("motionloggerdata.xlsx")

FOR <- FOR %>%  select(age,assessment_date,time_point,group,sex,race,subject_id,fid)
```

#2.0 Data Setup
##2.1 Fixing Clerical Errors
```{r}
Night$calendar_date <- as.Date(Night$calendar_date)
Night <- Night %>%
  mutate(
    calendar_date = case_when(
      filename == "800-0250-464_left wrist_068218_2025-12-01 14-08-11.bin" ~ calendar_date + 120,
      TRUE ~ calendar_date
    )
  )
Night$filename <- gsub("^800-304", "800-0304", Night$filename)
Night$filename <- gsub("^800-0066-106", "800-0065-106", Night$filename) # double check
Night$filename <- gsub("^800-0298-507", "800-0298-570", Night$filename)
Night$filename <- gsub("^800-0221-441", "800-0221-411", Night$filename)
Night$filename <- gsub("^0037062", "800-0037-062", Night$filename)

Night$Subject_ID <- substr(Night$filename, 1, 12)
Night <- Night %>%
  dplyr::rename(Assessment_Date = calendar_date)
Night <- Night %>% 
  filter(!str_detect(filename, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))

##Filtering bad extraction. Filtering a weird GGIR duplication?     
bin_files_to_remove <- c(
  "8000156273_left wrist_060381_2024-11-05 12-04-08_partial.bin"
)
Night <- Night %>%
  filter(!filename %in% bin_files_to_remove)
Night <- Night %>%
  filter(
    !(filename == "800-0250-464_left wrist_068218_2025-12-01 14-08-11.bin" &
    sleepparam == "spt_crude_estimate")
  )
```
##2.2 Merging
###2.2.1 GeneActiv
```{r}
Night <- Night %>%
  mutate(Subject_ID = gsub("^800-(\\d{3})-(\\d+)_$", "800-0\\1-\\2", Subject_ID))
Night$Subject_ID <- gsub("-", "", Night$Subject_ID)
Night$Subject_ID <- gsub("[a-zA-Z]", "", Night$Subject_ID)
Night$Subject_ID <- gsub("_", "", Night$Subject_ID)
FOR$Subject_ID <- gsub("-", "", as.character(FOR$subject_id))
setDT(Night)
setDT(FOR)

##GeneACTIV Merging
Night$geneactiv <- 1
FOR[, Assessment_Date := as.Date(assessment_date)]
FOR$Assessment_Date_FOR <- FOR$Assessment_Date
Night[, Assessment_Date := as.Date(Assessment_Date)]  # redundant if already Date
Night$Assessment_Date_Night <- Night$Assessment_Date
merged1 <- Night[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged1[, diffdays := (as.numeric(difftime(Assessment_Date_Night, Assessment_Date_FOR, units = "days")))]

merged1 <- merged1 %>% filter(diffdays >= 0 & diffdays <= 100)
```
###2.2.2 Motionlogger
```{r}
##Motion Logger Merging
NightM <- NightM %>%
  mutate(filename = paste0(ID, "motionlogg"))
NightM$weekday <- NightM$eday
NightM <- NightM %>% 
  filter(!str_detect(Subject_ID, "F[1-3]|f[1-3]|M[1-3]|m[1-3]|\\$R"))
setDT(NightM)
NightM[, Assessment_Date := as.Date(sdate)]
NightM$Assessment_Date_Night <- NightM$Assessment_Date
merged2 <- NightM[FOR, on = .(Subject_ID), allow.cartesian = TRUE]
merged2[, diffdays := abs(as.numeric(difftime(Assessment_Date_Night, Assessment_Date_FOR, units = "days")))]
merged2 <- merged2 %>% filter(diffdays >= 0 & diffdays <= 100)
merged2$motionlogger <- 1
```

###2.2.3 Final Merge
```{r}
#Combination of Motion and GeneActiv
merged <- rbindlist(list(merged1, merged2), fill = TRUE)
length(unique(merged$subject_id))
```

##2.3 Model Setup
###2.3.1 Calculate Midpoint
```{r message=FALSE, warning=FALSE}
#Setup
merged$sleeponset <- as.numeric(merged$sleeponset)
merged$wakeup <- as.numeric(merged$wakeup)

merged$midpoint <- (merged$wakeup + merged$sleeponset)/2
merged$midpoint <- merged$midpoint - 24
```

###2.3.2 Setting up data as specific structure
```{r}
merged <- merged %>%
  mutate(fhr = ifelse(group %in% c(1, 2, 3), 1, 0))

merged$weekend <- ifelse(merged$weekday %in% c("Fri", "Friday", "Sat", "Saturday"), 1, 0)
#Labeling
merged$fhr <- factor(merged$fhr,
                       levels = c(0, 1),
                       labels = c("Control", "FHR"))
merged$group <- factor(merged$group,
                       levels = c(0, 1, 2, 3),
                       labels = c("Control", "MDD Risk", "BD Risk", "Psy Risk"))
merged$sex <- factor(merged$sex,
                       levels = c(0, 1),
                       labels = c("Male", "Female"))
merged$weekend <- factor(merged$weekend,
                         levels = c(0, 1),
                         labels = c("Weekday", "Weekend"))
merged$age <- as.numeric(merged$age)
merged$subject_id <- as.factor(merged$subject_id)
merged$fid <- as.factor(merged$fid)
merged$SleepDurationInSpt <- as.numeric(merged$SleepDurationInSpt)
merged$fhr2 <- ordered(merged$fhr, levels = c("Control", "FHR")) # ???????
```

###2.3.3 Filtering 
```{r}
#Remove Psy Risk
merged <- merged %>% filter(age < 25 & age >= 8)
merged <- merged %>% filter(group != 'Psy Risk')

merged <- merged %>%
  group_by(filename) %>%   # or filename
  filter(
    sum(weekend == "Weekend", na.rm = TRUE) >= 1,
    sum(weekend == "Weekday", na.rm = TRUE) >= 3
  ) %>%
  ungroup()
```


#3.0 Main Analysis
##3.1 Nonlinear (Main)
```{r}
nonlinear_order <- gamm(
  midpoint ~ fhr2 + sex + weekend + s(age, k = 5) +
    s(age, by = fhr2, k = 5),        # additional smooth for FHR
  random = list(fid = ~1, subject_id = ~1),
  data = merged,
  method = "REML"
)

summary(nonlinear_order$gam)
draw(nonlinear_order)

p_mid <-  0.000164
f <- 8.74
```

###3.1.1 Comparison
```{r}
linear <- lmer(midpoint ~ fhr2*age + sex + weekend + (1|fid_new/subject_id), data = merged)

BIC(linear, nonlinear_order$lme)
```
####3.1.2 Visualization
#####3.1.2.1 Graph A
```{r}
#Model for Graph
nonlinear <- gamm(
  midpoint ~ fhr + sex + weekend + 
    s(age, by = fhr, k = 5),        # additional smooth for FHR
  random = list(fid = ~1, subject_id = ~1),
  data = merged,
  method = "REML"
)


age_seq <- seq(min(merged$age), max(merged$age), length.out = 200)

# Create a new data frame with average covariate values
newdat <- expand.grid(
  age = age_seq,
  fhr = factor(levels(merged$fhr), levels = levels(merged$fhr)),
  sex = factor(levels(merged$sex)[1], levels = levels(merged$sex)),         # hold sex constant
  weekend = factor(levels(merged$weekend)[1], levels = levels(merged$weekend))  # hold weekend constant
)

newdat$subject_id <- factor(merged$subject_id[1], levels = levels(merged$subject_id))

pred <- predict(nonlinear$gam, newdata = newdat, se.fit = TRUE, exclude = "s(subject_id)")

newdat$fit <- pred$fit
newdat$se <- pred$se.fit
z <- qnorm(0.975)  # 1.96
newdat <- newdat %>%
  mutate(
    lower = fit - z * se,
    upper = fit + z * se
  )

# 6. Plot adjusted smooths for groups with ggplot
sum <- merged %>%
  group_by(filename) %>%
    summarise(
      MIDm = mean(midpoint, na.rm = TRUE),
      age = mean(age, na.rm = TRUE),
      fhr = first(fhr)
    )

mgcv::plot.gam(nonlinear$gam)
MIDoutput <- ggplot() +
  # Raw data
  geom_point(data = sum,
             aes(x = age, y = MIDm, color = fhr),
             alpha = 0.25, size = 1.2) +
  
  # Model predictions
  geom_line(data = newdat,
            aes(x = age, y = fit, color = fhr),
            size = 1.2) +
  geom_ribbon(data = newdat,
              aes(x = age, ymin = lower, ymax = upper, fill = fhr),
              alpha = 0.25, color = NA) +
  
  # Scales (match both color & fill and give them the same legend title)
  scale_color_manual(
    name = "Group",                # ðŸ‘ˆ ensures both share same legend title
    values = c("Control" = "#6699FF", "FHR" = "#FF6666")
  ) +
  scale_fill_manual(
    name = "Group",                # ðŸ‘ˆ must be identical to color's 'name'
    values = c("Control" = "#6699FF", "FHR" = "#FF6666")
  ) +
  
scale_y_continuous(
  limits = c(0, 8),
  breaks = seq(0, 8, by = 2),
  labels = c("12:00 AM", "2:00 AM", "4:00 AM", "6:00 AM", "8:00 AM")
) +
  labs(
    title = "Observed and Modelled Sleep Midpoint by Group",
    x = "Age",
    y = "Sleep Midpoint"
  ) + 
  theme_minimal()
MIDoutput
```

#####3.1.2.2 Graph B
```{r}
#Differences
bands <- (confint(nonlinear_order$gam, n = 20000, "s(age):fhr2FHR", level = 0.95, type = "simultaneous"))
(confint(nonlinear_order$gam, "s(age):fhr2FHR", level = 0.95, type = "simultaneous"))

MIDdiff <- ggplot(bands, aes(x = age, y = .estimate)) +
  
  geom_hline(yintercept = 0, linewidth = 0.8) + 
  
  scale_x_continuous(
  limits = c(8, 25),
  breaks = seq(10, 25, by = 5)
) +
  
    # ---- Significant: 10 â†’ 14.04 ----
  geom_ribbon(
    data = subset(bands, age >= 8 & age <= 13),
    aes(ymin = .lower_ci, ymax = .upper_ci),
    fill  = "grey40",
    alpha = 0.5
  ) +
  
    # ---- Insignificant: 14.04 â†’ 17.5 ----
  geom_ribbon(
    data = subset(bands, age > 13 & age <= 16.45),
    aes(ymin = .lower_ci, ymax = .upper_ci),
    fill  = "grey75",
    alpha = 0.25
  ) +

  # ---- Significant: 10 â†’ 14.04 ----
  geom_ribbon(
    data = subset(bands, age > 16.45 & age <= 25),
    aes(ymin = .lower_ci, ymax = .upper_ci),
    fill  = "grey40",
    alpha = 0.5
  ) +

  geom_line(linewidth = 1.3) +

  labs(
    title = "Age-varying difference in midpoint",
    x = "Age (years)",
    y = "Difference in predicted midpoint"
  ) +

  theme_minimal()

MIDdiff




```

#####3.1.2.3 Combined Graph
```{r}
  library(patchwork)

MIDoutput <- MIDoutput +
  labs(tag = "(A)") +
  theme(
    plot.tag = element_text(size = 14, face = "bold"),
    plot.tag.position = c(0, 1),   # top-left
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )

MIDdiff <- MIDdiff +
  labs(tag = "(B)") +
  theme(
    plot.tag = element_text(size = 14, face = "bold"),
    plot.tag.position = c(0, 1),   # top-left
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, vjust = 1),
    plot.margin = margin(10, 10, 10, 10)
  )
MIDcombo <- MIDoutput + MIDdiff +
  plot_layout(ncol = 2, widths = c(1, 1)) +
  plot_annotation(
    title = "",
    theme = theme(
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      plot.margin = margin(15, 15, 15, 15)
    )
  )
MIDcombo
ggsave(
  "MID_Patchwork.png",
  plot = MIDcombo,
  width = 8.5, height = 6.5, units = "in", dpi = 600,
  bg = "white"
)


```


####3.1.3 Table
```{R}
#========================
# Helper functions
#========================
sig_stars <- function(p) {
  dplyr::case_when(
    is.na(p)  ~ "",
    p < 0.001 ~ "***",
    p < 0.01  ~ "**",
    p < 0.05  ~ "*",
    p < 0.10  ~ ".",
    TRUE      ~ ""
  )
}
fmt_num <- function(x, digits = 2) sprintf(paste0("%.", digits, "f"), x)

#========================
# FIXED EFFECTS (RAW -> formatted)
#========================
raw_fixed <- broom.mixed::tidy(
  nonlinear_order$lme,
  effects = "fixed",
  conf.int = TRUE
)

keep_terms <- c("X(Intercept)", "Xfhr2.L", "XsexFemale", "XweekendWeekend")

mod1 <- raw_fixed %>%
  filter(term %in% keep_terms) %>%
  mutate(
    term = recode(
      term,
      "X(Intercept)"    = "Intercept",
      "Xfhr2.L"         = "FHR (Group)",
      "XsexFemale"      = "Sex (Female)",
      "XweekendWeekend" = "Weekend",
      .default = term
    ),
    stars = sig_stars(p.value),
    `Effect (95% CI)` = paste0(
      fmt_num(estimate, 2),
      " (", fmt_num(conf.low, 2), ", ", fmt_num(conf.high, 2), ")",
      stars
    )
  ) %>%
  select(term, `Effect (95% CI)`)


#========================
# SMOOTH TERMS (edf + F + stars)
#========================
smooth_table <- as.data.frame(summary(nonlinear_order$gam)$s.table)

tbl_smooth <- smooth_table %>%
  rownames_to_column("term") %>%
  mutate(
    term = recode(
      term,
      "s(age)"         = "Smooth(Age)",
      "s(age):fhr2FHR" = "Smooth(Age) Ã— FHR"
    ),
    stars = sig_stars(`p-value`),
    `Effect (95% CI)` = paste0(
      fmt_num(F, 2), " (edf=", fmt_num(edf, 2), ")",
      stars
    )
  ) %>%
  select(term, `Effect (95% CI)`)

#========================
# Divider row + Combine
#========================
divider <- tibble(
  term = "Smooth Terms",
  `Effect (95% CI)` = ""
)

combined_df <- bind_rows(
  mod1,
  divider,
  tbl_smooth
)

combined_table <- flextable(combined_df) %>%
  set_caption("Model: Midpoint Time â€” General Additive Model") %>%
  bold(i = nrow(mod1) + 1, j = 1) %>%  # bold "Smooth Terms"
  autofit()

combined_table

save_as_docx(
  "Model: Midpoint â€” GAM" = combined_table,
  path = "MID_GAM_Table.docx"
)
```


##3.2 Linear
```{r}
vars_mod1 <- c(
  "midpoint",
  "fhr",
  "age",
  "sex",
  "weekend",
  "fid",
  "puberty_pds",
  "puberty_pds_female",
  "subject_id"
)

merged_mod1 <- merged %>%
  dplyr::select(all_of(vars_mod1)) %>%
  tidyr::drop_na()

dat_8_12 <- merged_mod1 %>%
  filter(age >= 8, age <= 12) %>%
  mutate(
    # make sure puberty_pds is numeric
    puberty_pds_num = suppressWarnings(as.numeric(as.character(puberty_pds_female))),
    
    # optional: check you didn't accidentally create tons of NAs
    # (you can inspect this after running)
    
    puberty_group = cut(
    puberty_pds_num,
    breaks = c(0.5, 1.5, 2.5, 3.5, 4.5, 5.5),
    labels = c(
      "Tanner I",
      "Tanner II",
      "Tanner III",
      "Tanner IV",
      "Tanner V"
    ))
  ) %>%
  drop_na(puberty_group) 

dat_8_12$age <- round(dat_8_12$age)
ggplot(
  dat_8_12 %>%
    group_by(age, fhr, puberty_group) %>%
    summarise(
      mean_midpoint = mean(midpoint),
      se_midpoint   = sd(midpoint) / sqrt(n()),
      .groups = "drop"
    ),
  aes(x = factor(age), y = mean_midpoint, fill = fhr)
) +
  geom_col(position = position_dodge(width = 0.9)) +
  geom_errorbar(
    aes(
      ymin = mean_midpoint - se_midpoint,
      ymax = mean_midpoint + se_midpoint
    ),
    width = 0.2,
    position = position_dodge(width = 0.9)
  ) +
  facet_wrap(~ puberty_group) +
  labs(
    title = "Sleep midpoint by age (8â€“12), stratified by puberty",
    x = "Age (years)",
    y = "Mean sleep midpoint",
    fill = "FHR group"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title  = element_text(size = 13),
    strip.text  = element_text(size = 12)
  )



mod1 <- lmer(midpoint ~ fhr*age + sex + weekend + (1|fid/subject_id), data = merged_mod1)
summary(mod1)

merged <- merged %>%
  mutate(puberty_pds = coalesce(puberty_pds_male, puberty_pds_female))
mod1_pub <- lmer(midpoint ~ fhr*age + sex + weekend + puberty_pds + (1|fid/subject_id), data = merged_mod1)
summary(mod1_pub)
anova(mod1, mod1_pub)




mod2 <- lmer(midpoint ~ group*age + sex + weekend + (1|fid/subject_id), data = merged)
anova(mod1, mod1_pub)
summary(mod2)
```


###3.2.1 Table
```{r}
library(dplyr)
library(broom.mixed)
library(flextable)
library(officer)
library(dplyr)
library(broom.mixed)
library(flextable)
library(officer)

mod1 <- lmer(midpoint ~ fhr2*age + sex + weekend + (1|fid_new/subject_id), data = merged)

apa_format <- function(model){
  broom.mixed::tidy(model, effects = "fixed", conf.int = TRUE) %>%
    mutate(
      Predictor = recode(term,
        "(Intercept)"     = "Intercept",
        "fhrFHR"          = "FHR",
        "age"             = "Age",
        "fhrFHR:age"      = "FHR Ã— Age",
        "groupMDD Risk"            = "MDD",
        "groupBD Risk"             = "BD",
        "groupMDD Risk:age"        = "Age Ã— MDD",
        "groupBD Risk:age"         = "Age Ã— BD",
        "sexFemale"       = "Sex (Female)",
        "weekendWeekend"  = "Weekend"
      ),
      stars = dplyr::case_when(
        p.value < .001 ~ "***",
        p.value < .01  ~ "**",
        p.value < .05  ~ "*",
        TRUE           ~ ""
      ),
      `Î² [95% CI]` = sprintf("%.2f%s [%.2f, %.2f]", estimate, stars, conf.low, conf.high)
    ) %>%
    select(Predictor, `Î² [95% CI]`)
}

m1 <- apa_format(mod1)

order_terms <- c(
  "Intercept",
  "FHR",
  "Age",
  "FHR Ã— Age",
  "MDD",
  "BD",
  "Age Ã— MDD",
  "Age Ã— BD",
  "Sex (Female)",
  "Weekend"
)

m1 <- m1 %>%
  mutate(Predictor = factor(Predictor, levels = order_terms)) %>%
  arrange(Predictor)

ft <- flextable(m1) %>%
  set_header_labels(
    Predictor = "Predictor",
    `Î² [95% CI]` = "Î² [95% CI]"
  ) %>%
  add_header_row(
    values = c("", "Model 1"),
    colwidths = c(1, 1)
  ) %>%
  merge_h(part = "header") %>%
  autofit() %>%
  align(j = 2, align = "center") %>%
  align(j = 1, align = "left") %>%
  bold(part = "header") %>%
  add_footer_lines(values = c(
    "Note. Values are Î² with 95% confidence intervals in brackets.",
    "* p < .05. ** p < .01. *** p < .001."
  ))

ft

save_as_docx(
  "Linear Mixed Model Predicting MID (Model 2)" = ft,
  path = "MID_Model1_APA_LMER_Table.docx"
)
```
